<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enterprise Finance Dashboard v8</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --navy: #0a1128; --hitam: #050814; --hitam-card: #12182b; --putih: #f8fafc;
            --merah: #ef4444; --kuning: #f59e0b; --hijau: #10b981; --biru: #3b82f6;
            --border: #1e293b; --text-muted: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif; background-color: var(--navy); color: var(--putih);
            margin: 0; padding: 20px; line-height: 1.5; touch-action: manipulation; overflow-x: hidden;
            box-sizing: border-box;
        }

        *, *::before, *::after { box-sizing: inherit; }

        /* === PROFILE HEADER === */
        .profile-header {
            display: flex; align-items: center; justify-content: space-between; background: var(--hitam-card);
            padding: 15px 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px;
            cursor: pointer; transition: transform 0.2s;
        }
        .profile-header:active { transform: scale(0.98); }
        .profile-info { display: flex; align-items: center; gap: 15px; }
        .profile-pic-container { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--biru); overflow: hidden; flex-shrink: 0; background: var(--hitam); }
        .profile-pic { width: 100%; height: 100%; object-fit: cover; }
        .profile-title { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 800; letter-spacing: 1px; display: block;}
        .profile-name { font-size: 18px; font-weight: 900; margin: 0; display: flex; align-items: center; gap: 8px;}

        /* === CONTROLS & WALLET SWITCHER === */
        .controls-header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .wallet-switcher {
            position: relative; display: flex; width: 100%; background: var(--hitam); padding: 5px;
            border-radius: 12px; border: 1px solid var(--border);
        }
        .wallet-slider {
            position: absolute; top: 5px; bottom: 5px; left: 5px; width: calc(50% - 5px);
            background: var(--biru); border-radius: 8px; transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .wallet-switcher[data-active="tabungan"] .wallet-slider { transform: translateX(100%); background: var(--kuning); }
        
        .btn-tab {
            flex: 1; position: relative; z-index: 1; padding: 14px 0; background: transparent; border: none;
            color: var(--text-muted); font-weight: 900; font-size: 14px; cursor: pointer; transition: all 0.3s;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-tab.active { color: var(--putih); font-size: 15px; }
        .wallet-switcher[data-active="harian"] .btn-tab#tab-harian { text-shadow: 0 0 12px rgba(59, 130, 246, 0.9); }
        .wallet-switcher[data-active="tabungan"] .btn-tab#tab-tabungan { color: var(--hitam); text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }

        /* === UNIVERSAL CUSTOM SELECT DROPDOWN === */
        .custom-select-wrapper { position: relative; width: 100%; margin-bottom: 20px; }
        .custom-select-trigger {
            width: 100%; padding: 16px; background: var(--hitam); border: 1px solid var(--border);
            border-radius: 10px; color: var(--putih); font-size: 14px; font-weight: 700; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; transition: border-color 0.3s;
        }
        .custom-select-trigger:active { border-color: var(--biru); }
        .custom-options {
            position: absolute; top: 100%; left: 0; right: 0; background: var(--hitam-card);
            border: 1px solid var(--border); border-radius: 10px; margin-top: 5px; z-index: 2000;
            max-height: 250px; overflow-y: auto; opacity: 0; visibility: hidden; transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .custom-options.open { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-option { padding: 14px 16px; font-size: 14px; font-weight: 600; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .custom-option:last-child { border-bottom: none; }
        .custom-option:hover { background: var(--biru); color: white; }

        .time-filter-wrapper { width: 180px; margin-bottom: 0; }
        .time-filter-wrapper .custom-select-trigger { padding: 12px 15px; font-size: 13px; background: var(--hitam-card); }

        /* === EXPANDABLE FLEX GRID === */
        .expand-container { display: flex; gap: 10px; width: 100%; margin-bottom: 15px; transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .expand-item {
            flex: 1 1 0; min-width: 0; max-width: 100%; background: var(--hitam-card); border: 1px solid var(--border);
            border-radius: 16px; padding: 20px 15px; position: relative; cursor: pointer;
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); overflow: hidden; display: flex; flex-direction: column;
            box-sizing: border-box;
        }
        
        .expand-item.expanded { flex: 1 1 100%; align-items: center; justify-content: center; text-align: center; }
        .expand-item.expanded .card-label { font-size: 14px; margin-bottom: 10px; }
        .expand-item.expanded .card-value { font-size: 40px; }
        .expand-item.collapsed { flex: 0 0 0%; border: none; padding: 0; margin: 0; opacity: 0; pointer-events: none; }
        
        .btn-close-expand {
            position: absolute; top: 12px; right: 12px; 
            background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            color: var(--merah); width: 34px; height: 34px; border-radius: 50%; font-weight: 900; font-size: 14px;
            display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 50;
        }
        .btn-close-expand:active { transform: scale(0.9); }
        .expand-item.expanded .btn-close-expand { display: flex; }

        .card-label { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; white-space: nowrap; transition: all 0.3s;}
        .card-value { font-size: 24px; font-weight: 900; margin: 0; letter-spacing: -1px; white-space: nowrap; transition: all 0.3s;}
        
        .chart-box { height: 200px; width: 100%; transition: height 0.5s cubic-bezier(0.25, 1, 0.5, 1); position: relative; }
        .expand-item.expanded .chart-box { height: 350px; }

        .text-hijau { color: var(--hijau); } .text-merah { color: var(--merah); } .text-biru { color: var(--biru); } .text-kuning { color: var(--kuning); }

        /* === COLLAPSIBLE SECTIONS === */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
        .section-title { font-size: 14px; font-weight: 900; margin: 0; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;}
        .toggle-icon { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .toggle-icon.rotated { transform: rotate(180deg); }
        .collapsible-content { max-height: 2500px; opacity: 1; overflow: hidden; transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease; }
        .collapsible-content.hidden { max-height: 0; opacity: 0; pointer-events: none; margin: 0; }

        /* === QUICK ACTIONS === */
        .quick-actions-wrap { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; -ms-overflow-style: none; scrollbar-width: none; margin-top: 25px; }
        .quick-actions-wrap::-webkit-scrollbar { display: none; }
        .quick-actions-wrap.grid-split-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

        .btn-quick {
            background: var(--hitam-card); border: 2px solid var(--border); color: var(--putih);
            padding: 16px 15px; border-radius: 12px; font-weight: 800; font-size: 13px;
            cursor: pointer; white-space: nowrap; transition: all 0.3s; 
            display: flex; align-items: center; justify-content: center; gap: 8px; flex-shrink: 0;
        }
        .btn-quick svg { width: 18px; height: 18px; }
        .btn-quick.glow-merah { border-color: var(--merah); color: var(--merah); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2); }
        .btn-quick.glow-biru { border-color: var(--biru); color: var(--biru); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2); }
        .btn-quick.glow-kuning { border-color: var(--kuning); color: var(--kuning); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2); }
        .btn-quick.glow-ungu { border-color: #a855f7; color: #a855f7; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.2); }
        .btn-quick.glow-hijau { border-color: var(--hijau); color: var(--hijau); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); }
        .btn-quick:active { transform: scale(0.95); }

        /* === TABLE === */
        .table-container { background: var(--hitam-card); border: 1px solid var(--border); border-radius: 16px; overflow-x: auto; }
        table { width: 100%; min-width: 600px; border-collapse: collapse; text-align: left; }
        th { background: rgba(0,0,0,0.4); padding: 15px; font-size: 12px; color: var(--text-muted); text-transform: uppercase; font-weight: 800; white-space: nowrap;}
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; font-weight: 600; white-space: nowrap;}
        tr:last-child td { border-bottom: none; }
        .badge-cat { display: inline-block; width: 130px; text-align: center; padding: 6px 0; border-radius: 6px; font-size: 11px; font-weight: 900; white-space: nowrap; box-sizing: border-box; text-transform: uppercase; letter-spacing: 0.5px;}
        .amt-cell { text-align: right; font-family: 'Courier New', Courier, monospace; font-variant-numeric: tabular-nums; font-size: 16px; font-weight: 900; letter-spacing: -0.5px; }

        .btn-lunasi { 
            background: var(--hijau); color: var(--hitam); border: none; padding: 8px 14px; 
            border-radius: 6px; font-weight: 900; font-size: 11px; cursor: pointer; text-transform: uppercase; 
            transition: 0.2s; box-shadow: 0 0 12px rgba(16, 185, 129, 0.6); margin-top: 5px;
        }
        .btn-lunasi:active { transform: scale(0.9); }
        .hutang-banner { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--merah); padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* === MODALS === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(5, 8, 20, 0.9); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-card { background: var(--hitam-card); border: 1px solid var(--border); border-radius: 20px; width: 90%; max-width: 400px; padding: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9); transform: scale(0.9) translateY(20px); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height: 90vh; overflow-y: auto; }
        .modal-overlay.active .modal-card { transform: scale(1) translateY(0); opacity: 1; }
        
        .input-label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; }
        .input-field { width: 100%; padding: 16px; background: var(--hitam); border: 1px solid var(--border); border-radius: 10px; color: var(--putih); font-size: 15px; font-weight: 700; font-family: inherit; box-sizing: border-box; transition: border-color 0.3s; margin-bottom: 20px; outline: none;}
        .input-field:focus { border-color: var(--biru); }
        .btn-modal { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; background: var(--biru); color: white; margin-top: 5px; transition: transform 0.2s; font-size: 15px; text-transform: uppercase;}
        .btn-modal:active { transform: scale(0.97); }
        .btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }

        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px;}
        .toast { background: var(--hitam-card); border-bottom: 4px solid; color: var(--putih); padding: 14px 24px; border-radius: 8px; font-weight: 800; font-size: 13px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6); transform: translateY(-100%); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center;}
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { border-color: var(--merah); } .toast.success { border-color: var(--hijau); }

        .prof-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; text-align: left;}
        .prof-detail-box { background: var(--hitam); border: 1px solid var(--border); padding: 12px 15px; border-radius: 12px; }
        .prof-detail-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 800; display: block; margin-bottom: 3px;}
        .prof-detail-val { font-size: 14px; font-weight: 700; color: var(--putih); margin: 0;}

        .status-sync { font-size: 11px; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 5px; font-weight: 700; }
        .sync-online { background: rgba(16, 185, 129, 0.2); color: var(--hijau); }
        .sync-offline { background: rgba(59, 130, 246, 0.2); color: var(--biru); }
    </style>
</head>
<body>

    <div id="toastBox" class="toast-container"></div>

    <div class="profile-header" onclick="openProfileView()">
        <div class="profile-info">
            <div class="profile-pic-container"><img src="" id="headProfileImg" class="profile-pic"></div>
            <div class="profile-name-wrap">
                <span class="profile-title" id="headGender">MEMBER</span>
                <h1 class="profile-name" id="headName">Guest</h1>
                <div id="networkStatus" class="status-sync sync-offline">Online Mode</div>
            </div>
        </div>
    </div>

    <div class="controls-header">
        <div class="wallet-switcher" id="walletSwitchContainer" data-active="harian">
            <div class="wallet-slider"></div>
            <button class="btn-tab active" onclick="switchWallet('harian')" id="tab-harian">Dompet Harian</button>
            <button class="btn-tab" onclick="switchWallet('tabungan')" id="tab-tabungan">Brankas Tabungan</button>
        </div>
        
        <div class="custom-select-wrapper time-filter-wrapper">
            <div class="custom-select-trigger" onclick="toggleCustomSelect('timeFilterOptions')">
                <span id="dispTimeFilter">Semua Waktu</span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
            </div>
            <div class="custom-options" id="timeFilterOptions">
                <div class="custom-option" onclick="applyTimeFilter(0, 'Semua Waktu')">Semua Waktu</div>
                <div class="custom-option" onclick="applyTimeFilter(1, 'Hari Ini')">Hari Ini</div>
                <div class="custom-option" onclick="applyTimeFilter(7, '7 Hari Terakhir')">7 Hari Terakhir</div>
                <div class="custom-option" onclick="applyTimeFilter(30, '30 Hari Terakhir')">30 Hari Terakhir</div>
                <div class="custom-option" onclick="applyTimeFilter(365, '1 Tahun Terakhir')">1 Tahun Terakhir</div>
                <div class="custom-option" onclick="applyTimeFilter(730, '2 Tahun Terakhir')">2 Tahun Terakhir</div>
                <div class="custom-option" onclick="applyTimeFilter(1825, '5 Tahun Terakhir')">5 Tahun Terakhir</div>
            </div>
        </div>
    </div>

    <div class="expand-container" id="statContainer">
        <div class="expand-item" onclick="toggleExpandStat(this, 'statContainer')">
            <span class="card-label">Saldo Aktif</span><p class="card-value text-hijau" id="disp-saldo">Rp 0</p>
        </div>
        <div class="expand-item" onclick="toggleExpandStat(this, 'statContainer')">
            <span class="card-label">Pemasukan</span><p class="card-value text-biru" id="disp-masuk">Rp 0</p>
        </div>
        <div class="expand-item" onclick="toggleExpandStat(this, 'statContainer')">
            <span class="card-label">Pengeluaran</span><p class="card-value text-merah" id="disp-keluar">Rp 0</p>
        </div>
    </div>

    <div class="section-header" onclick="toggleSection('chartsSection', 'chartToggleIcon')">
        <h2 class="section-title">Analitik Visual</h2>
        <svg id="chartToggleIcon" class="toggle-icon rotated" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
    </div>
    <div class="collapsible-content" id="chartsSection">
        <div class="expand-container" id="chartContainer">
            <div class="expand-item" onclick="expandChart(this, 'chartContainer')">
                <button class="btn-close-expand" onclick="closeChart(event, this)">✕</button>
                <span class="card-label">Distribusi</span>
                <div class="chart-box"><canvas id="pieChart"></canvas></div>
            </div>
            <div class="expand-item" onclick="expandChart(this, 'chartContainer')">
                <button class="btn-close-expand" onclick="closeChart(event, this)">✕</button>
                <span class="card-label">Timeline</span>
                <div class="chart-box"><canvas id="barChart"></canvas></div>
            </div>
            <div class="expand-item" onclick="expandChart(this, 'chartContainer')">
                <button class="btn-close-expand" onclick="closeChart(event, this)">✕</button>
                <span class="card-label">Arus Kas</span>
                <div class="chart-box"><canvas id="lineChart"></canvas></div>
            </div>
        </div>
    </div>

    <div class="quick-actions-wrap" id="quickActionsContainer"></div>

    <div class="section-header" onclick="toggleSection('historySection', 'historyToggleIcon')">
        <h2 class="section-title">Riwayat Transaksi</h2>
        <svg id="historyToggleIcon" class="toggle-icon rotated" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
    </div>
    
    <div id="debtBannerContainer"></div>

    <div class="collapsible-content" id="historySection">
        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Waktu</th><th>Kategori</th><th>Deskripsi/Peminjam</th><th style="text-align: right;">Nominal</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="profileViewModal">
        <div class="modal-card">
            <div style="text-align: center; margin-bottom: 25px; position: relative;">
                <div class="profile-pic-container" style="width: 80px; height: 80px; margin: 0 auto 10px auto; border-color:var(--putih);">
                    <img src="" id="viewProfileImg" class="profile-pic">
                </div>
                <h2 style="margin:0; font-size: 26px; font-weight:900;" id="viewProfileName">Guest</h2>
                <p style="margin:5px 0 0 0; font-size: 12px; color: var(--text-muted); font-weight:700;" id="viewJoinDate"></p>
                <button onclick="requestProfileEdit()" style="position: absolute; top: 0; right: 0; background:var(--hitam); border:1px solid var(--border); color:var(--text-muted); padding:10px; border-radius:10px; cursor:pointer;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
            </div>
            
            <div class="prof-detail-grid">
                <div class="prof-detail-box"><span class="prof-detail-label">Gender</span><p class="prof-detail-val" id="viewGender">-</p></div>
                <div class="prof-detail-box"><span class="prof-detail-label">Tgl Lahir</span><p class="prof-detail-val" id="viewBirth">-</p></div>
                <div class="prof-detail-box"><span class="prof-detail-label">Total Pemasukan</span><p class="prof-detail-val text-hijau" id="viewTotalMasuk">Rp 0</p></div>
                <div class="prof-detail-box"><span class="prof-detail-label">Total Pengeluaran</span><p class="prof-detail-val text-merah" id="viewTotalKeluar">Rp 0</p></div>
                
                <div class="prof-detail-box" style="grid-column: span 2; display:flex; justify-content:space-between; align-items:center; border-color:#4285F4;">
                    <div style="text-align: left;">
                        <span class="prof-detail-label">Akses Cloud Firebase</span>
                        <p class="prof-detail-val" id="viewGoogleStatus" style="color:var(--text-muted); font-size: 13px;">Tidak Terhubung</p>
                    </div>
                    <button id="btnGoogleLink" class="btn-quick glow-biru" style="padding: 8px 12px; font-size:11px; border-color:#4285F4; color:#4285F4;" onclick="openGoogleAuthModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z"/></svg> 
                        <span id="textGoogleLink">Hubungkan</span>
                    </button>
                </div>
            </div>
            <button class="btn-modal btn-cancel" onclick="closeModal('profileViewModal')">Tutup</button>
        </div>
    </div>

    <div class="modal-overlay" id="googleAuthModal">
        <div class="modal-card" style="text-align: center;">
            <h2 style="margin-top:0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Sinkronisasi Cloud</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 25px;">Login untuk menyimpan data Anda dengan aman ke server Firebase secara real-time.</p>
            
            <button class="btn-modal" id="btnRealGoogleLogin" style="display:flex; align-items:center; justify-content:center; gap:10px; background:#fff; color:#000; padding:15px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z"/></svg> 
                Login dengan Google
            </button>

            <button class="btn-modal btn-cancel" onclick="closeModal('googleAuthModal')" style="margin-top: 15px;">Batal</button>
        </div>
    </div>

    <div class="modal-overlay" id="pinAuthModal">
        <div class="modal-card" style="max-width: 320px; text-align: center;">
            <h2 style="margin-top:0;">Otorisasi</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">Masukkan PIN Profil Anda.</p>
            <input type="password" id="inputAuthPin" class="input-field" placeholder="****" inputmode="numeric" maxlength="6" style="text-align: center; font-size: 26px; letter-spacing: 8px;">
            <button class="btn-modal" onclick="verifyPinAndEdit()">Buka Akses</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('pinAuthModal')">Batal</button>
        </div>
    </div>

    <div class="modal-overlay" id="profileEditModal">
        <div class="modal-card">
            <h2 style="margin-top:0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Edit Profil</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="profile-pic-container" style="width: 70px; height: 70px; margin: 0 auto; cursor: pointer;" onclick="document.getElementById('profileUploader').click()">
                    <img src="" id="editProfileImg" class="profile-pic">
                    <div style="position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.7); font-size:9px; padding:2px;">EDIT</div>
                </div>
                <input type="file" id="profileUploader" accept="image/*" style="display: none;">
            </div>

            <label class="input-label">Nama Lengkap</label>
            <input type="text" id="editName" class="input-field" placeholder="Nama Anda" autocomplete="off">
            
            <label class="input-label">Gender</label>
            <div class="custom-select-wrapper">
                <div class="custom-select-trigger" onclick="toggleCustomSelect('genderOptions')">
                    <span id="dispGenderVal">Pilih Gender</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                </div>
                <div class="custom-options" id="genderOptions">
                    <div class="custom-option" onclick="selectGender('Laki-Laki')">Laki-Laki</div>
                    <div class="custom-option" onclick="selectGender('Wanita')">Wanita</div>
                    <div class="custom-option" onclick="selectGender('Rahasia')">Rahasia</div>
                </div>
            </div>
            <input type="hidden" id="editGender">

            <label class="input-label">Tanggal Lahir (Ketik Angka Saja)</label>
            <input type="text" id="editBirth" class="input-field" placeholder="DD/MM/YYYY" inputmode="numeric" autocomplete="off">
            
            <label class="input-label text-kuning">Security PIN (Opsional)</label>
            <input type="password" id="editPin" class="input-field" placeholder="Ketik PIN untuk kunci profil" inputmode="numeric" maxlength="6" style="border-color:var(--kuning);">

            <button class="btn-modal" onclick="saveProfileData()">Simpan Perubahan</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('profileEditModal')">Batal</button>
        </div>
    </div>

    <div class="modal-overlay" id="txModal">
        <div class="modal-card">
            <h2 id="modal-title" style="margin-top:0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Input Data</h2>
            
            <input type="hidden" id="tx-type">
            
            <label class="input-label" id="label-kategori">Kategori</label>
            <div class="custom-select-wrapper" id="catSelectWrapper">
                <div class="custom-select-trigger" onclick="toggleCustomSelect('catOptionsBox')">
                    <span id="dispTxCat">Pilih Kategori</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                </div>
                <div class="custom-options" id="catOptionsBox"></div>
            </div>
            <input type="hidden" id="tx-category">
            
            <div id="catInputWrapper" style="display: none; margin-bottom:20px;">
                <input type="text" id="tx-category-manual" class="input-field" placeholder="Ketik kategori / nama manual..." style="margin:0;">
            </div>

            <div id="borrowerWrapper" style="display: none;">
                <label class="input-label text-kuning">Nama Peminjam</label>
                <input type="text" id="tx-borrower" class="input-field" placeholder="Ketik nama peminjam..." autocomplete="off">
            </div>

            <label class="input-label">Deskripsi</label>
            <input type="text" id="tx-desc" class="input-field" autocomplete="off">
            
            <label class="input-label">Nominal (Rp)</label>
            <input type="text" id="tx-amount" class="input-field text-kuning" inputmode="numeric" placeholder="0" autocomplete="off" style="font-size: 26px; font-weight: 900; text-align: right;">
            
            <button type="button" class="btn-modal" id="btnExecuteTx">Eksekusi Transaksi</button>
            <button type="button" class="btn-modal btn-cancel" onclick="closeModal('txModal')">Batal</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-card" style="text-align:center;">
            <h2 style="margin-top:0;" id="confirmTitle">Konfirmasi</h2>
            <p id="confirmDesc" style="color:var(--text-muted); font-size:14px;">Apakah Anda yakin?</p>
            <button class="btn-modal" id="btnConfirmYes">Ya, Lanjutkan</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('confirmModal')">Batal</button>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, enableIndexedDbPersistence, collection, onSnapshot, addDoc, updateDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // 1. KONFIGURASI FIREBASE (GANTI JIKA PERLU)
        const firebaseConfig = {
            apiKey: "AIzaSyAwirxPa2d4J17OcZZpgjnAGI-bIFTyC-o",
            authDomain: "enterprise-finance-db.firebaseapp.com",
            projectId: "enterprise-finance-db",
            storageBucket: "enterprise-finance-db.firebasestorage.app",
            messagingSenderId: "226013433272",
            appId: "1:226013433272:web:18c4802010aed7289f934d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const dbFirestore = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // 2. AKTIFKAN CACHE OFFLINE FIRESTORE
        enableIndexedDbPersistence(dbFirestore).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn("Multiple tabs open. Offline persistence hanya aktif di satu tab.");
            } else if (err.code == 'unimplemented') {
                console.warn("Browser ini tidak mendukung offline persistence.");
            }
        });

        // 3. GLOBAL STATE
        let db = JSON.parse(localStorage.getItem('finance_modern_db')) || [];
        let currentUser = null;
        let unsubscribeSnapshot = null;
        let activeWallet = 'harian';
        let currentTimeFilter = 0; 
        let rawAmount = 0;
        let pieChart, barChart, lineChart;

        const defaultProfile = { 
            name: 'Guest', pin: '', 
            photo: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzFlMjliYiI+PHBhdGggZD0iTTEyIDJhNSA1IDAgMSAwIDUgNSBNMTIgMTRhNyA3IDAgMCAwLTcgN3YxSDE5di0xYTcgNyAwIDAgMC03LTdaIi8+PC9zdmc+', 
            joinDate: new Date().toISOString(), birthDate: '', gender: 'Rahasia', googleLinked: false, googleEmail: ''
        };
        let profile = JSON.parse(localStorage.getItem('user_profile')) || defaultProfile;

        const svgs = {
            makan: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            transport: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="7" cy="16" r="1"/><circle cx="17" cy="16" r="1"/><path d="M14 11V7a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v4"/></svg>`,
            uang: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>`,
            atm: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h12M6 12h2M10 12h2M14 12h2M6 16h6"/></svg>`,
            plus: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            pinjam: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3v3m-4-3v3M7 3v3m14 8H3m18 4H3m2-14h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2z"/></svg>`
        };
        const categories = { masuk: ['Gaji', 'Top-Up', 'Bonus', 'Usaha'], keluar: ['Makan', 'Transport', 'Belanja', 'Tagihan'] };

        // 4. AUTENTIKASI & SINKRONISASI REAL-TIME
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('networkStatus').innerText = "Online Mode (Cloud)";
                document.getElementById('networkStatus').className = "status-sync sync-online";
                
                profile.googleLinked = true;
                profile.googleEmail = user.email;
                if(profile.name === 'Guest') profile.name = user.displayName;
                profile.photo = user.photoURL || profile.photo;
                localStorage.setItem('user_profile', JSON.stringify(profile));
                
                initAppHeader();
                
                // Real-time listener. Offline persistence akan menangani ini otomatis saat internet mati.
                const q = query(collection(dbFirestore, `users/${user.uid}/transactions`), orderBy("date", "asc"));
                unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                    db = [];
                    snapshot.forEach((doc) => {
                        db.push({ id: doc.id, ...doc.data() }); 
                    });
                    updateUI();
                });
            } else {
                currentUser = null;
                document.getElementById('networkStatus').innerText = "Offline Mode (Lokal)";
                document.getElementById('networkStatus').className = "status-sync sync-offline";
                
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot();
                    unsubscribeSnapshot = null;
                }
                
                db = JSON.parse(localStorage.getItem('finance_modern_db')) || [];
                updateUI();
            }
        });

        document.getElementById('btnRealGoogleLogin').addEventListener('click', () => {
            // Akan gagal jika dibuka lewat file:/// atau domain belum di-whitelist di Firebase Console
            signInWithPopup(auth, googleProvider).then((result) => {
                showToast("Berhasil Login ke Cloud", "success");
                closeModal('googleAuthModal');
            }).catch((error) => {
                console.error(error);
                showToast("Login Gagal: Pastikan akses via localhost/server", "error");
            });
        });

        // 5. UTILITY & HEADER
        const formatRp = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        function formatDetailDate(iso) {
            if(!iso) return '-';
            const d = new Date(iso); const m = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Ags','Sep','Okt','Nov','Des'];
            return `${String(d.getDate()).padStart(2,'0')} ${m[d.getMonth()]} ${d.getFullYear()} - ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }
        function showToast(msg, type = 'success') {
            const box = document.getElementById('toastBox');
            if(!box) return; 
            const t = document.createElement('div');
            t.className = `toast ${type}`; t.innerText = msg; box.appendChild(t);
            setTimeout(() => t.classList.add('show'), 10);
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
        }
        function closeModal(id) { 
            const el = document.getElementById(id); if(el) el.classList.remove('active'); 
            document.querySelectorAll('.custom-options.open').forEach(el => el.classList.remove('open')); 
        }
        function smartCapitalize(str) {
            if(!str) return "";
            if(str === str.toUpperCase()) return str; 
            if(str === str.toLowerCase()) return str.replace(/\b\w/g, char => char.toUpperCase());
            return str; 
        }
        function initAppHeader() {
            document.getElementById('headName').innerText = profile.name;
            document.getElementById('headGender').innerText = profile.gender;
            document.getElementById('headProfileImg').src = profile.photo;
        }
        initAppHeader();

        // 6. EKSPOR FUNGSI KE WINDOW (Wajib karena Module scope)
        window.switchWallet = (type) => {
            activeWallet = type; document.getElementById('walletSwitchContainer').setAttribute('data-active', type);
            renderShortcuts(); updateUI();
        };
        window.toggleCustomSelect = (id) => {
            const box = document.getElementById(id); const isOpen = box.classList.contains('open');
            document.querySelectorAll('.custom-options.open').forEach(el => el.classList.remove('open')); 
            if(!isOpen) box.classList.add('open');
        };
        window.applyTimeFilter = (days, labelText) => { 
            currentTimeFilter = days; document.getElementById('dispTimeFilter').innerText = labelText; 
            closeModal(''); updateUI(); 
        };
        window.selectGender = (val) => { document.getElementById('editGender').value = val; document.getElementById('dispGenderVal').innerText = val; closeModal(''); };
        window.selectCategory = (val) => { document.getElementById('tx-category').value = val; document.getElementById('dispTxCat').innerText = val; closeModal(''); };
        window.closeModal = closeModal;
        
        window.openGoogleAuthModal = () => {
            if(currentUser) {
                if(confirm("Yakin ingin logout dari Cloud? Aplikasi akan kembali ke mode lokal.")) {
                    signOut(auth).then(() => {
                        profile.googleLinked = false; profile.googleEmail = '';
                        localStorage.setItem('user_profile', JSON.stringify(profile));
                        showToast("Logout berhasil", "success");
                        closeModal('profileViewModal');
                    });
                }
            } else {
                document.getElementById('googleAuthModal').classList.add('active');
            }
        };

        window.openProfileView = () => {
            let inT = 0, outT = 0; db.forEach(t => { if(t.type === 'masuk') inT += t.amount; else outT += t.amount; });
            document.getElementById('viewProfileImg').src = profile.photo;
            document.getElementById('viewProfileName').innerText = profile.name;
            document.getElementById('viewJoinDate').innerText = "Bergabung: " + formatDetailDate(profile.joinDate);
            document.getElementById('viewGender').innerText = profile.gender;
            document.getElementById('viewBirth').innerText = profile.birthDate || '-';
            document.getElementById('viewTotalMasuk').innerText = formatRp(inT);
            document.getElementById('viewTotalKeluar').innerText = formatRp(outT);
            
            const stat = document.getElementById('viewGoogleStatus');
            const btnText = document.getElementById('textGoogleLink');
            const btn = document.getElementById('btnGoogleLink');
            
            if(currentUser) {
                stat.innerHTML = `<span style="color:var(--hijau); font-weight:700;">${currentUser.email}</span>`;
                btnText.innerText = "Logout"; btn.style.borderColor = "var(--merah)"; btn.style.color = "var(--merah)";
            } else {
                stat.innerText = "Tidak Terhubung"; stat.style.color = "var(--text-muted)";
                btnText.innerText = "Hubungkan"; btn.style.borderColor = "#4285F4"; btn.style.color = "#4285F4";
            }
            document.getElementById('profileViewModal').classList.add('active');
        };

        window.requestProfileEdit = () => {
            if(profile.pin && profile.pin !== '') {
                closeModal('profileViewModal');
                document.getElementById('inputAuthPin').value = '';
                document.getElementById('pinAuthModal').classList.add('active');
                setTimeout(() => document.getElementById('inputAuthPin').focus(), 300);
            } else { window.openProfileEdit(); }
        };

        window.verifyPinAndEdit = () => {
            if(document.getElementById('inputAuthPin').value === profile.pin) {
                closeModal('pinAuthModal'); window.openProfileEdit();
            } else { showToast("PIN Salah!", "error"); }
        };

        window.openProfileEdit = () => {
            closeModal('profileViewModal');
            document.getElementById('editProfileImg').src = profile.photo;
            document.getElementById('editName').value = profile.name !== 'Guest' ? profile.name : '';
            window.selectGender(profile.gender);
            document.getElementById('editBirth').value = profile.birthDate;
            document.getElementById('editPin').value = profile.pin;
            document.getElementById('profileEditModal').classList.add('active');
        };

        window.saveProfileData = () => {
            profile.name = smartCapitalize(document.getElementById('editName').value.trim()) || 'Guest';
            profile.gender = document.getElementById('editGender').value;
            profile.birthDate = document.getElementById('editBirth').value;
            profile.pin = document.getElementById('editPin').value;
            localStorage.setItem('user_profile', JSON.stringify(profile));
            initAppHeader(); closeModal('profileEditModal'); showToast("Profil Disimpan");
        };

        window.toggleExpandStat = (clickedElement, containerId) => {
            const items = document.getElementById(containerId).children;
            if (clickedElement.classList.contains('expanded')) {
                for(let item of items) item.className = 'expand-item';
            } else {
                for(let item of items) item.className = (item === clickedElement) ? 'expand-item expanded' : 'expand-item collapsed';
            }
        };

        window.expandChart = (clickedElement, containerId) => {
            if(!clickedElement.classList.contains('expanded')) {
                for(let item of document.getElementById(containerId).children) item.className = (item === clickedElement) ? 'expand-item expanded' : 'expand-item collapsed';
                setTimeout(() => { if(pieChart) pieChart.resize(); if(barChart) barChart.resize(); if(lineChart) lineChart.resize(); }, 500);
            }
        };

        window.closeChart = (e, btn) => {
            e.stopPropagation(); 
            for(let item of btn.closest('.expand-container').children) item.className = 'expand-item';
            setTimeout(() => { if(pieChart) pieChart.resize(); if(barChart) barChart.resize(); if(lineChart) lineChart.resize(); }, 500);
        };

        window.toggleSection = (sectionId, iconId) => { 
            document.getElementById(sectionId).classList.toggle('hidden'); 
            document.getElementById(iconId).classList.toggle('rotated'); 
        };

        // 7. INPUT TRANSAKSI (SINKRONISASI FIRESTORE & LOKAL)
        let isLoanMode = false;
        window.quickInput = (type, category, desc, isLoan = false) => {
            isLoanMode = isLoan;
            document.getElementById('tx-type').value = type;
            document.getElementById('modal-title').innerText = isLoan ? 'Catat Uang Dipinjam' : (type === 'masuk' ? 'Input Pemasukan' : 'Input Pengeluaran');
            
            document.getElementById('tx-desc').value = '';
            document.getElementById('tx-category-manual').value = '';
            document.getElementById('tx-borrower').value = '';
            
            if(category === 'MANUAL') {
                document.getElementById('catSelectWrapper').style.display = 'none';
                document.getElementById('catInputWrapper').style.display = 'block';
                document.getElementById('label-kategori').innerText = 'Ketik Nama / Kategori';
            } else {
                document.getElementById('catSelectWrapper').style.display = 'block';
                document.getElementById('catInputWrapper').style.display = 'none';
                document.getElementById('label-kategori').innerText = 'Kategori';
                
                const optsBox = document.getElementById('catOptionsBox');
                const catArr = type==='masuk' ? categories.masuk : categories.keluar;
                optsBox.innerHTML = catArr.map(c => `<div class="custom-option" onclick="selectCategory('${c}')">${c}</div>`).join('');
                if(!catArr.includes(category)) optsBox.innerHTML += `<div class="custom-option" onclick="selectCategory('${category}')">${category}</div>`;
                window.selectCategory(category);
            }

            const bw = document.getElementById('borrowerWrapper');
            if(isLoanMode) { bw.style.display = 'block'; document.getElementById('tx-desc').value = 'Uang Dipinjamkan'; } 
            else { bw.style.display = 'none'; document.getElementById('tx-desc').value = desc; }
            
            document.getElementById('tx-amount').value = ''; rawAmount = 0;
            document.getElementById('txModal').classList.add('active');
            
            setTimeout(() => { 
                if(isLoanMode) document.getElementById('tx-borrower').focus();
                else if(category==='MANUAL') document.getElementById('tx-category-manual').focus(); 
                else document.getElementById('tx-amount').focus(); 
            }, 300);
        };

        document.getElementById('tx-amount').addEventListener('input', function() { 
            let v = this.value.replace(/[^0-9]/g, ''); 
            if(v==='') { rawAmount=0; this.value=''; return; } 
            rawAmount = parseInt(v, 10); this.value = rawAmount.toLocaleString('id-ID'); 
        });

        let confirmAction = null;
        window.openConfirm = (title, desc, onConfirm) => {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmDesc').innerText = desc;
            confirmAction = onConfirm;
            document.getElementById('confirmModal').classList.add('active');
        };
        
        document.getElementById('btnConfirmYes').addEventListener('click', () => { if(confirmAction) confirmAction(); closeModal('confirmModal'); });

        window.lunasiPinjaman = (txId) => {
            const txIndex = db.findIndex(t => t.id === txId);
            if(txIndex > -1) {
                const tx = db[txIndex];
                window.openConfirm("Pelunasan", `Uang ${formatRp(tx.amount)} dari ${tx.borrower} kembali ke tabungan?`, () => {
                    const lunasData = { wallet: 'tabungan', type: 'masuk', category: 'Lunas Pinjaman', desc: `Dikembalikan oleh ${tx.borrower}`, amount: tx.amount, date: new Date().toISOString() };
                    
                    if(currentUser) {
                        updateDoc(doc(dbFirestore, `users/${currentUser.uid}/transactions/${tx.id}`), { status: 'lunas_pinjaman' });
                        addDoc(collection(dbFirestore, `users/${currentUser.uid}/transactions`), lunasData);
                    } else {
                        db[txIndex].status = 'lunas_pinjaman'; 
                        lunasData.id = Date.now();
                        db.push(lunasData);
                        localStorage.setItem('finance_modern_db', JSON.stringify(db));
                        updateUI();
                    }
                    showToast("Pinjaman Lunas", "success");
                });
            }
        };

        function checkAndAutoLunasHutang() {
            let sIn = 0, sOut = 0;
            db.filter(t => t.wallet === 'harian').forEach(t => { if(t.type === 'masuk') sIn += t.amount; else sOut += t.amount; });
            if((sIn - sOut) >= 0) {
                let debtCleared = false;
                db.forEach(t => {
                    if(t.wallet === 'harian' && t.status === 'hutang') {
                        if(currentUser) updateDoc(doc(dbFirestore, `users/${currentUser.uid}/transactions/${t.id}`), { status: 'lunas_hutang' });
                        else t.status = 'lunas_hutang';
                        debtCleared = true;
                    }
                });
                if(debtCleared && !currentUser) localStorage.setItem('finance_modern_db', JSON.stringify(db));
                if(debtCleared) showToast("Hutang otomatis lunas!", "success");
            }
        }

        document.getElementById('btnExecuteTx').addEventListener('click', () => {
            if(rawAmount <= 0) { showToast("Nominal tidak boleh nol", "error"); return; }
            const type = document.getElementById('tx-type').value;
            let cF = document.getElementById('catInputWrapper').style.display === 'block' ? document.getElementById('tx-category-manual').value.trim() : document.getElementById('tx-category').value;
            let dF = document.getElementById('tx-desc').value.trim();
            
            if(!cF || !dF) { showToast("Kategori & Deskripsi wajib diisi", "error"); return; }
            cF = smartCapitalize(cF); dF = smartCapitalize(dF);
            
            let status = 'normal'; let borrowerName = '';

            if(activeWallet === 'harian' && type === 'keluar') {
                let sIn = 0, sOut = 0; db.filter(t => t.wallet === 'harian').forEach(t => { if(t.type === 'masuk') sIn += t.amount; else sOut += t.amount; });
                if((sIn - sOut) - rawAmount < 0) { status = 'hutang'; showToast("Dicatat sebagai Hutang", "error"); }
            } else if (activeWallet === 'tabungan' && type === 'keluar') {
                let sIn = 0, sOut = 0; db.filter(t => t.wallet === 'tabungan').forEach(t => { if(t.type === 'masuk') sIn += t.amount; else sOut += t.amount; });
                if(rawAmount > (sIn - sOut)) { showToast("Ditolak: Saldo kurang!", "error"); return; }
                if (isLoanMode) {
                    borrowerName = smartCapitalize(document.getElementById('tx-borrower').value.trim());
                    if(!borrowerName) { showToast("Nama peminjam wajib diisi", "error"); return; }
                    status = 'dipinjam'; showToast(`Dipinjamkan ke ${borrowerName}`);
                }
            }

            const txData = { wallet: activeWallet, type: type, category: cF, desc: dF, borrower: borrowerName, status: status, amount: rawAmount, date: new Date().toISOString() };

            if(currentUser) {
                // Eksekusi Cloud. Jika offline, Firestore menyimpan cache.
                addDoc(collection(dbFirestore, `users/${currentUser.uid}/transactions`), txData).then(()=>{
                    if(activeWallet === 'harian' && type === 'masuk') checkAndAutoLunasHutang();
                });
                closeModal('txModal'); showToast("Data diproses...", "success");
            } else {
                // Eksekusi Lokal
                txData.id = Date.now();
                db.push(txData);
                localStorage.setItem('finance_modern_db', JSON.stringify(db));
                closeModal('txModal');
                if(activeWallet === 'harian' && type === 'masuk') checkAndAutoLunasHutang();
                updateUI(); showToast("Tersimpan Lokal");
            }
        });

        // 8. RENDER ENGINE (Tabel & Grafik)
        function renderShortcuts() {
            const c = document.getElementById('quickActionsContainer');
            if(activeWallet === 'harian') {
                c.className = 'quick-actions-wrap';
                c.innerHTML = `
                   <button class="btn-quick glow-merah" onclick="quickInput('keluar', 'Makan', 'Beli Makan')">${svgs.makan} Beli Makan</button>
                   <button class="btn-quick glow-merah" onclick="quickInput('keluar', 'Transport', 'Isi Bensin')">${svgs.transport} Transport</button>
                   <button class="btn-quick glow-biru" onclick="quickInput('masuk', 'Top-Up', 'Isi Saldo')">${svgs.uang} Top-Up Harian</button>
                   <button class="btn-quick glow-kuning" onclick="quickInput('keluar', 'MANUAL', '')">${svgs.plus} Lainnya (-)</button>
                   <button class="btn-quick glow-hijau" onclick="quickInput('masuk', 'MANUAL', '')">${svgs.plus} Lainnya (+)</button>`;
            } else {
                c.className = 'quick-actions-wrap grid-split-3';
                c.innerHTML = `
                   <button class="btn-quick glow-kuning" onclick="quickInput('masuk', 'Top-Up', 'Setor Tabungan')">${svgs.uang} Setor</button>
                   <button class="btn-quick glow-merah" onclick="quickInput('keluar', 'Lainnya', 'Tarik Tabungan')">${svgs.atm} Tarik</button>
                   <button class="btn-quick glow-ungu" onclick="quickInput('keluar', 'Dipinjam', 'Pinjamkan Uang', true)">${svgs.pinjam} Dipinjam</button>`;
            }
        }

        function updateUI() {
            const today = new Date(); today.setHours(0,0,0,0);
            
            let tInGlobal = 0, tOutGlobal = 0;
            db.filter(t => t.wallet === 'harian').forEach(t => { if(t.type === 'masuk') tInGlobal += t.amount; else tOutGlobal += t.amount; });
            
            const debtBanner = document.getElementById('debtBannerContainer');
            if(activeWallet === 'harian' && (tInGlobal - tOutGlobal) < 0) {
                debtBanner.innerHTML = `<div class="hutang-banner"><div><span style="font-size:11px; font-weight:900; color:var(--merah); text-transform:uppercase;">Status Defisit</span><br><span style="font-size:16px; font-weight:900; color:var(--putih);">Saldo Minus: ${formatRp(Math.abs(tInGlobal - tOutGlobal))}</span></div><button class="btn-quick glow-biru" style="padding:10px 15px; font-size:12px;" onclick="quickInput('masuk','Top-Up','Tutup Hutang')">Top-Up Sekarang</button></div>`;
            } else { debtBanner.innerHTML = ''; }

            const filteredData = db.filter(tx => {
                if(tx.wallet !== activeWallet) return false;
                if(currentTimeFilter === 0) return true;
                const tDate = new Date(tx.date); tDate.setHours(0,0,0,0);
                return Math.floor(Math.abs(today - tDate) / (1000 * 60 * 60 * 24)) <= currentTimeFilter;
            });

            let tM = 0, tK = 0;
            filteredData.forEach(tx => { if(tx.type === 'masuk') tM += tx.amount; else tK += tx.amount; });

            document.getElementById('disp-saldo').innerText = formatRp(tM - tK);
            document.getElementById('disp-masuk').innerText = formatRp(tM);
            document.getElementById('disp-keluar').innerText = formatRp(tK);

            renderTable(filteredData); renderCharts(filteredData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body'); tbody.innerHTML = '';
            const sorted = [...data].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(tx => {
                const isM = tx.type === 'masuk'; let cClass = isM ? 'var(--biru)' : 'var(--merah)';
                let descRender = `<span style="font-weight:700;">${tx.desc}</span>`;
                if(tx.status === 'dipinjam') descRender = `<span style="font-weight:700; color:#a855f7;">${tx.desc}</span><br><span style="font-size:11px; color:var(--text-muted);">Ke: ${tx.borrower}</span>`;
                
                let catRender = `<div class="badge-cat" style="border: 1px solid ${cClass}; color:${cClass}; background:rgba(0,0,0,0.5);">${tx.category}</div>`;
                if(tx.status === 'hutang') catRender = `<div style="display:flex; flex-direction:column; gap:5px;"><div class="badge-cat" style="border: 1px solid var(--merah); color:var(--merah); background:rgba(239,68,68,0.2);">LUNASI HUTANG</div></div>`;
                else if (tx.status === 'lunas_hutang') catRender = `<div class="badge-cat" style="border: 1px solid var(--hijau); color:var(--hijau); background:rgba(16,185,129,0.1);">LUNAS</div>`;
                else if (tx.status === 'dipinjam') { cClass = '#a855f7'; catRender = `<div style="display:flex; flex-direction:column; gap:5px;"><div class="badge-cat" style="border: 1px solid ${cClass}; color:${cClass}; background:rgba(168,85,247,0.2);">DIPINJAM</div><button class="btn-lunasi" onclick="lunasiPinjaman('${tx.id}')">TANDAI LUNAS</button></div>`; }
                else if (tx.status === 'lunas_pinjaman') catRender = `<div class="badge-cat" style="border: 1px solid var(--hijau); color:var(--hijau); background:rgba(16,185,129,0.1);">PINJAMAN LUNAS</div>`;

                tbody.innerHTML += `<tr><td style="color:var(--text-muted); font-size:11px;">${formatDetailDate(tx.date).split(' - ')[0]}<br>${formatDetailDate(tx.date).split(' - ')[1]}</td><td>${catRender}</td><td>${descRender}</td><td class="amt-cell" style="color:${cClass};">${isM?'+':'-'}${formatRp(tx.amount).padStart(12, ' ')}</td></tr>`;
            });
        }

        function renderCharts(data) {
            Chart.defaults.color = '#64748b'; Chart.defaults.font.family = 'Inter';
            const catA = {}; data.forEach(t => { const k = `${t.category}`; catA[k] = { amt: (catA[k]?.amt||0)+t.amount, typ: t.type }; });
            const pL = Object.keys(catA);
            
            if(pieChart) pieChart.destroy();
            pieChart = new Chart(document.getElementById('pieChart'), { type: 'doughnut', data: { labels: pL, datasets: [{ data: pL.map(l=>catA[l].amt), backgroundColor: pL.map(l=>catA[l].typ==='masuk'?'#3b82f6':'#ef4444'), borderWidth: 4, borderColor: '#050814' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} } } });

            const rTx = [...data].sort((a,b) => new Date(a.date) - new Date(b.date)).slice(-15);
            if(barChart) barChart.destroy();
            barChart = new Chart(document.getElementById('barChart'), { type: 'bar', data: { labels: rTx.map(t=>t.desc.substring(0,8)), datasets: [{ data: rTx.map(t=> t.type==='masuk'?t.amount:-t.amount), backgroundColor: rTx.map(t=> t.type==='masuk'?'#3b82f6':'#ef4444'), borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: {x:{display:false}, y:{grid:{color:'#1e293b'}}} } });

            let cumIn = 0, cumOut = 0, histIn = [], histOut = [];
            const sortedData = [...data].sort((a,b)=> new Date(a.date)-new Date(b.date));
            sortedData.forEach(t => { if(t.type === 'masuk') cumIn += t.amount; else cumOut += t.amount; histIn.push(cumIn); histOut.push(cumOut); });

            if(lineChart) lineChart.destroy();
            lineChart = new Chart(document.getElementById('lineChart'), { type: 'line', data: { labels: sortedData.map((_,i)=> `T${i+1}`), datasets: [{ label: 'Pemasukan', data: histIn, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3, pointRadius: 2 }, { label: 'Pengeluaran', data: histOut, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.3, pointRadius: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: {x:{display:false}, y:{grid:{color:'#1e293b'}}} } });
        }

        renderShortcuts(); updateUI();
    </script>
</body>
</html>
