<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Enterprise Finance Dashboard v21.0 (True Offline)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script async src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script async src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --navy: #0a1128; --hitam: #050814; --hitam-card: #12182b; --putih: #f8fafc;
            --merah: #ef4444; --kuning: #f59e0b; --oranye: #f97316; --hijau: #10b981; --biru: #3b82f6;
            --border: #1e293b; --text-muted: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif; background-color: var(--navy); color: var(--putih);
            margin: 0; padding: 20px; line-height: 1.5; touch-action: manipulation; overflow-x: hidden;
            box-sizing: border-box;
            overscroll-behavior-y: none; /* Membunuh pull-to-refresh Android */
        }

        *, *::before, *::after { box-sizing: inherit; }

        .visually-hidden {
            position: absolute !important; width: 1px !important; height: 1px !important;
            padding: 0 !important; margin: -1px !important; overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important; white-space: nowrap !important; border: 0 !important;
        }

        /* LAYAR AUTO-UPDATE */
        #updateScreen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--navy); z-index: 99999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 0.5s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(16, 185, 129, 0.3);
            border-top-color: var(--hijau); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* === PROFILE HEADER === */
        .profile-header {
            display: flex; align-items: center; justify-content: space-between; background: var(--hitam-card);
            padding: 15px 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px;
            cursor: pointer; transition: transform 0.2s; position: relative;
        }
        .profile-header:active { transform: scale(0.98); }
        .profile-info { display: flex; align-items: center; gap: 15px; width: 100%; }
        .profile-pic-container { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--biru); overflow: hidden; flex-shrink: 0; background: var(--hitam); position: relative; }
        .profile-pic { width: 100%; height: 100%; object-fit: cover; }
        .profile-title { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 800; letter-spacing: 1px; display: block;}
        .profile-name { font-size: 18px; font-weight: 900; margin: 0; display: flex; align-items: center; gap: 8px;}

        /* FINANCIAL HEALTH INDICATOR */
        .health-badge { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); padding: 6px 10px; border-radius: 8px; font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid; display: flex; flex-direction: column; align-items: center; background: var(--hitam-card); transition: all 0.3s;}
        .health-badge span { font-size: 8px; opacity: 0.8; margin-bottom: 2px; }
        .health-sehat { border-color: var(--hijau); color: var(--hijau); box-shadow: 0 0 10px rgba(16, 185, 129, 0.15); }
        .health-waspada { border-color: var(--kuning); color: var(--kuning); box-shadow: 0 0 10px rgba(245, 158, 11, 0.15); }
        .health-kritis { border-color: var(--oranye); color: var(--oranye); box-shadow: 0 0 10px rgba(249, 115, 22, 0.2); }
        .health-defisit { border-color: var(--merah); color: var(--merah); background: rgba(239, 68, 68, 0.15); box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
        .health-netral { border-color: var(--text-muted); color: var(--text-muted); }

        /* === CONTROLS & WALLET SWITCHER === */
        .controls-header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; }
        .wallet-switcher {
            position: relative; display: flex; width: 100%; background: var(--hitam); padding: 5px;
            border-radius: 12px; border: 1px solid var(--border);
        }
        .wallet-slider {
            position: absolute; top: 5px; bottom: 5px; left: 5px; width: calc(50% - 5px);
            background: var(--biru); border-radius: 8px; transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .wallet-switcher[data-active="tabungan"] .wallet-slider { transform: translateX(100%); background: var(--kuning); }
        
        .btn-tab {
            flex: 1; position: relative; z-index: 1; padding: 14px 0; background: transparent; border: none;
            color: var(--text-muted); font-weight: 900; font-size: 14px; cursor: pointer; transition: all 0.3s;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-tab.active { color: var(--putih); font-size: 15px; }
        .wallet-switcher[data-active="harian"] .btn-tab#tab-harian { text-shadow: 0 0 12px rgba(59, 130, 246, 0.9); }
        .wallet-switcher[data-active="tabungan"] .btn-tab#tab-tabungan { color: var(--hitam); text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }

        /* === DROPDOWN UNIVERSAL === */
        .custom-select-wrapper { position: relative; width: 100%; margin-bottom: 20px; }
        .custom-select-trigger {
            width: 100%; height: 100%; padding: 16px; background: var(--hitam); border: 1px solid var(--border);
            border-radius: 10px; color: var(--putih); font-size: 15px; font-weight: 700; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; transition: border-color 0.3s;
            box-sizing: border-box;
        }
        .custom-select-trigger:active { border-color: var(--biru); }
        .custom-options {
            position: absolute; top: calc(100% + 5px); left: 0; right: 0; background: var(--hitam-card);
            border: 1px solid var(--border); border-radius: 10px; z-index: 9999;
            max-height: 250px; overflow-y: auto; opacity: 0; visibility: hidden; transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 15px 35px rgba(0,0,0,0.9);
        }
        .custom-options.open { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-option { padding: 14px 16px; font-size: 14px; font-weight: 600; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .custom-option:last-child { border-bottom: none; }
        .custom-option:hover { background: var(--biru); color: white; }
        
        /* FILTER WAKTU & INSIGHT AI ROW */
        .filter-insight-row { display: flex; gap: 10px; width: 100%; margin-bottom: 25px; align-items: stretch; height: 90px; }
        .time-filter-wrapper { width: 95px; margin-bottom: 0; flex-shrink: 0; position: relative; height: 100%; }
        .time-filter-wrapper .custom-select-trigger { padding: 0 8px; font-size: 10px; font-weight: 800; background: var(--hitam-card); height: 100%; text-align: left; }
        
        /* KOTAK INSIGHT AI */
        .insight-box { background: rgba(59, 130, 246, 0.08); border-left: 3px solid var(--biru); padding: 12px 15px; border-radius: 8px; font-weight: 600; color: var(--putih); display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden; height: 100%; box-sizing: border-box; }
        .insight-box svg { flex-shrink: 0; color: var(--biru); width: 18px; height: 18px; }
        .insight-box span { font-size: 11.5px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; text-align: left; width: 100%; word-wrap: break-word; margin: 0; padding: 0; }
        .fade-transition { transition: opacity 0.4s ease-in-out; opacity: 1; }
        .fade-out { opacity: 0; }

        /* === EXPANDABLE FLEX GRID === */
        .expand-container { display: flex; gap: 10px; width: 100%; margin-bottom: 15px; transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .expand-container:has(.expanded) { gap: 0; }
        
        .expand-item { flex: 1 1 0; min-width: 0; max-width: 100%; background: var(--hitam-card); border: 1px solid var(--border); border-radius: 16px; padding: 15px 10px; position: relative; cursor: pointer; transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box; }
        .expand-item.expanded { flex: 1 1 100%; align-items: center; justify-content: center; text-align: center; }
        .expand-item.expanded .card-label { font-size: 14px; margin-bottom: 10px; }
        
        .card-label { font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; white-space: nowrap; transition: all 0.3s;}
        
        /* PSEUDO ELEMENT UNTUK ANGKA ... */
        .card-value { 
            font-size: clamp(14px, 4vw, 18px); 
            font-weight: 900; 
            margin: 0; 
            letter-spacing: -0.5px; 
            white-space: nowrap; 
            overflow: hidden;    
            text-overflow: ellipsis;
            width: 100%; 
            transition: all 0.3s;
        }
        .card-value::after { content: attr(data-short); }
        .expand-item.expanded .card-value { font-size: 26px; white-space: normal; word-break: break-word; }
        .expand-item.expanded .card-value::after { content: attr(data-full); }
        
        .expand-item.collapsed { flex: 0 0 0%; border: none; padding: 0; margin: 0; opacity: 0; pointer-events: none; }
        
        .btn-close-expand { position: absolute; top: 12px; right: 12px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); color: var(--merah); width: 34px; height: 34px; border-radius: 50%; font-weight: 900; font-size: 14px; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 50; }
        .btn-close-expand:active { transform: scale(0.9); }
        .expand-item.expanded .btn-close-expand { display: flex; }

        .chart-box { height: 200px; width: 100%; transition: height 0.5s cubic-bezier(0.25, 1, 0.5, 1); position: relative; min-height: 200px; }
        .expand-item.expanded .chart-box { height: 350px; min-height: 350px; }

        .text-hijau { color: var(--hijau); } .text-merah { color: var(--merah); } .text-biru { color: var(--biru); } .text-kuning { color: var(--kuning); }

        /* === SECTIONS & QUICK ACTIONS === */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
        .section-title { font-size: 14px; font-weight: 900; margin: 0; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;}
        .toggle-icon { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .toggle-icon.rotated { transform: rotate(180deg); }
        .collapsible-content { max-height: 2500px; opacity: 1; overflow: hidden; transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease; }
        .collapsible-content.hidden { max-height: 0; opacity: 0; pointer-events: none; margin: 0; }

        .quick-actions-wrap { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; -ms-overflow-style: none; scrollbar-width: none; margin-top: 25px; }
        .quick-actions-wrap::-webkit-scrollbar { display: none; }
        
        .quick-actions-wrap.grid-mode { display: grid; gap: 10px; }
        .grid-split-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-split-4 { grid-template-columns: repeat(2, 1fr); }

        .btn-quick { background: var(--hitam-card); border: 2px solid var(--border); color: var(--putih); padding: 16px 20px; border-radius: 12px; font-weight: 800; font-size: 13px; cursor: pointer; white-space: nowrap; transition: all 0.3s; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .btn-quick svg { width: 18px; height: 18px; flex-shrink: 0; position: absolute; left: 20px; }
        .btn-quick span { text-align: center; }
        
        .btn-quick.glow-merah { border-color: var(--merah); color: var(--merah); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2); }
        .btn-quick.glow-biru { border-color: var(--biru); color: var(--biru); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2); }
        .btn-quick.glow-kuning { border-color: var(--kuning); color: var(--kuning); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2); }
        .btn-quick.glow-ungu { border-color: #a855f7; color: #a855f7; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.2); }
        .btn-quick.glow-hijau { border-color: var(--hijau); color: var(--hijau); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); }
        .btn-quick:active { transform: scale(0.95); }

        #btnGoogleLink svg { position: static; margin-right: 5px; }

        .btn-sosmed { display: flex; align-items: center; gap: 8px; flex: 1; justify-content: center; padding: 12px; border-radius: 10px; font-size: 12px; font-weight: 800; text-decoration: none; transition: all 0.3s; cursor: pointer; }
        .btn-sosmed:active { transform: scale(0.95); }
        .btn-sosmed.ig { background: rgba(225, 48, 108, 0.1); color: #E1306C; border: 1px solid rgba(225, 48, 108, 0.3); }
        .btn-sosmed.tt { background: rgba(255, 255, 255, 0.05); color: var(--putih); border: 1px solid var(--border); }
        .btn-sosmed svg { width: 16px; height: 16px; }

        /* === TABLE & SEARCH === */
        .search-container { position: relative; width: 100%; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 14px 45px 14px 15px; background: var(--hitam-card); border: 1px solid var(--border); border-radius: 10px; color: var(--putih); font-size: 13px; font-family: inherit; font-weight: 600; outline: none; transition: border-color 0.3s;}
        .search-input:focus { border-color: var(--biru); box-shadow: 0 0 10px rgba(59, 130, 246, 0.2); }
        .search-clear { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); cursor: pointer; display: none; font-weight: bold; }
        
        .table-container { background: var(--hitam-card); border: 1px solid var(--border); border-radius: 16px; overflow-x: auto; }
        table { width: 100%; min-width: 600px; border-collapse: collapse; text-align: left; }
        th { background: rgba(0,0,0,0.4); padding: 15px; font-size: 12px; color: var(--text-muted); text-transform: uppercase; font-weight: 800; white-space: nowrap;}
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; font-weight: 600; white-space: nowrap;}
        tr:last-child td { border-bottom: none; }
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background: rgba(255,255,255,0.03); }
        .clickable-row:active { background: rgba(255,255,255,0.06); }
        
        .badge-cat { display: inline-block; width: 130px; text-align: center; padding: 6px 0; border-radius: 6px; font-size: 11px; font-weight: 900; white-space: nowrap; box-sizing: border-box; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-lunasi { background: var(--hijau); color: var(--hitam); border: none; padding: 8px 0; border-radius: 6px; font-weight: 900; font-size: 11px; cursor: pointer; text-transform: uppercase; transition: 0.2s; box-shadow: 0 0 12px rgba(16, 185, 129, 0.6); margin-top: 5px; width: 130px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .btn-lunasi:active { transform: scale(0.95); }
        .amt-cell { text-align: right; font-family: 'Courier New', Courier, monospace; font-variant-numeric: tabular-nums; font-size: 16px; font-weight: 900; letter-spacing: -0.5px; }
        .hutang-banner { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--merah); padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* === MODALS === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(5, 8, 20, 0.9); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: flex-start; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; overflow-y: auto; padding: 40px 15px; box-sizing: border-box; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-card { background: var(--hitam-card); border: 1px solid var(--border); border-radius: 20px; width: 100%; max-width: 400px; padding: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9); transform: scale(0.9) translateY(20px); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin: auto; position: relative; overflow: visible; }
        .modal-overlay.active .modal-card { transform: scale(1) translateY(0); opacity: 1; }
        
        .receipt-card { background: #0f172a; border: 2px dashed #334155; border-radius: 12px; padding: 25px; text-align: left; position: relative; margin-bottom: 15px;}
        .receipt-card::before, .receipt-card::after { content: ''; position: absolute; width: 20px; height: 20px; background: rgba(5, 8, 20, 0.9); border-radius: 50%; top: 60px; }
        .receipt-card::before { left: -12px; border-right: 2px dashed #334155; }
        .receipt-card::after { right: -12px; border-left: 2px dashed #334155; }
        .receipt-head { text-align: center; border-bottom: 2px dashed #334155; padding-bottom: 15px; margin-bottom: 20px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; align-items: flex-start;}
        .receipt-label { color: var(--text-muted); font-weight: 700; width: 40%; }
        .receipt-val { font-weight: 900; text-align: right; width: 60%; word-break: break-word; }

        .input-label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; }
        .input-field { width: 100%; padding: 16px; background: var(--hitam); border: 1px solid var(--border); border-radius: 10px; color: var(--putih); font-size: 15px; font-weight: 700; font-family: inherit; box-sizing: border-box; transition: border-color 0.3s; margin-bottom: 20px; outline: none; }
        .input-field:focus { border-color: var(--biru); }
        
        .btn-modal { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; background: var(--biru); color: white; margin-top: 5px; transition: transform 0.2s; font-size: 15px; text-transform: uppercase;}
        .btn-modal:active { transform: scale(0.97); }
        .btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }

        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px;}
        .toast { background: var(--hitam-card); border-bottom: 4px solid; color: var(--putih); padding: 14px 24px; border-radius: 8px; font-weight: 800; font-size: 13px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6); transform: translateY(-100%); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center;}
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { border-color: var(--merah); } .toast.success { border-color: var(--hijau); }
        .toast.syncing { border-color: var(--biru); background: rgba(59, 130, 246, 0.9); }

        .prof-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; text-align: left;}
        .prof-detail-box { background: var(--hitam); border: 1px solid var(--border); padding: 12px 15px; border-radius: 12px; }
        .prof-detail-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 800; display: block; margin-bottom: 3px;}
        .prof-detail-val { font-size: 14px; font-weight: 700; color: var(--putih); margin: 0;}

        /* CSS Status Sinkronisasi */
        .status-sync { font-size: 11px; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 5px; font-weight: 700; }
        .sync-online { background: rgba(16, 185, 129, 0.2); color: var(--hijau); }
        .sync-offline { background: rgba(245, 158, 11, 0.2); color: var(--kuning); }
        .sync-pending { background: rgba(59, 130, 246, 0.2); color: var(--biru); }
    </style>
</head>
<body>
    
    <div id="updateScreen" style="display:none;">
        <div class="spinner"></div>
        <p style="font-size: 12px; font-weight: 800; color: var(--text-muted); margin-top: 20px; letter-spacing: 1px;">MENERAPKAN UPDATE VERSI BARU...</p>
    </div>

    <div id="toastBox" class="toast-container"></div>
    <div class="profile-header" onclick="openProfileView()">
        <div class="profile-info">
            <div class="profile-pic-container"><img src="" id="headProfileImg" class="profile-pic"></div>
            <div class="profile-name-wrap">
                <span class="profile-title" id="headGender">MEMBER</span>
                <h1 class="profile-name" id="headName">Guest</h1>
                <div id="networkStatus" class="status-sync sync-offline">Offline Mode</div>
            </div>
        </div>
        <div id="healthBadge" class="health-badge health-netral">
            <span>STATUS</span>
            <div id="healthText">Netral</div>
        </div>
    </div>

    <div class="controls-header">
        <div class="wallet-switcher" id="walletSwitchContainer" data-active="harian">
            <div class="wallet-slider"></div>
            <button class="btn-tab active" onclick="switchWallet('harian')" id="tab-harian">Dompet Harian</button>
            <button class="btn-tab" onclick="switchWallet('tabungan')" id="tab-tabungan">Brankas Tabungan</button>
        </div>
    </div>

    <div class="filter-insight-row">
        <div class="custom-select-wrapper time-filter-wrapper" style="margin-bottom: 0;">
            <div class="custom-select-trigger" onclick="toggleCustomSelect('timeFilterOptions')">
                <span id="dispTimeFilter">Semua Waktu</span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
            </div>
            <div class="custom-options" id="timeFilterOptions">
                <div class="custom-option" onclick="applyTimeFilter(365, 'Semua Waktu')">Semua Waktu (1 Tahun)</div>
                <div class="custom-option" onclick="applyTimeFilter(1, 'Hari Ini')">Hari Ini</div>
                <div class="custom-option" onclick="applyTimeFilter(7, '7 Hari Terakhir')">7 Hari Terakhir</div>
                <div class="custom-option" onclick="applyTimeFilter(30, '30 Hari Terakhir')">30 Hari Terakhir</div>
                <div class="custom-option" onclick="applyTimeFilter(365, '1 Tahun Belakang')">1 Tahun Belakang</div>
                <div class="custom-option" onclick="applyTimeFilter(730, '2 Tahun Belakang')">2 Tahun Belakang</div>
                <div class="custom-option" onclick="applyTimeFilter(1095, '3 Tahun Belakang')">3 Tahun Belakang</div>
                <div class="custom-option" onclick="applyTimeFilter(1825, '5 Tahun Belakang')">5 Tahun Belakang</div>
                <div class="custom-option" onclick="applyTimeFilter(3650, '10 Tahun Belakang')">10 Tahun Belakang</div>
                <div class="custom-option" onclick="applyTimeFilter(36500, '100 Tahun Arsip')">100 Tahun Arsip</div>
            </div>
        </div>
        
        <div id="aiInsightBox" class="insight-box" style="display: flex;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            <span id="aiInsightText" class="fade-transition">Menganalisis data keuanganmu...</span>
        </div>
    </div>

    <div class="expand-container" id="statContainer">
        <div class="expand-item" onclick="toggleExpandStat(this, 'statContainer')">
            <span class="card-label">Saldo Aktif</span>
            <p class="card-value text-hijau" id="disp-saldo" data-short="Rp 0" data-full="Rp 0"></p>
        </div>
        <div class="expand-item" onclick="toggleExpandStat(this, 'statContainer')">
            <span class="card-label">Pemasukan</span>
            <p class="card-value text-biru" id="disp-masuk" data-short="Rp 0" data-full="Rp 0"></p>
        </div>
        <div class="expand-item" onclick="toggleExpandStat(this, 'statContainer')">
            <span class="card-label">Pengeluaran</span>
            <p class="card-value text-merah" id="disp-keluar" data-short="Rp 0" data-full="Rp 0"></p>
        </div>
    </div>

    <div class="section-header" onclick="toggleSection('chartsSection', 'chartToggleIcon')">
        <h2 class="section-title">Analitik Visual</h2>
        <svg id="chartToggleIcon" class="toggle-icon rotated" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
    </div>
    <div class="collapsible-content" id="chartsSection">
        <div class="expand-container" id="chartContainer">
            <div class="expand-item" onclick="expandChart(this, 'chartContainer')">
                <button class="btn-close-expand" onclick="closeChart(event, this)">✕</button>
                <span class="card-label">Distribusi</span>
                <div class="chart-box"><canvas id="pieChart"></canvas></div>
            </div>
            <div class="expand-item" onclick="expandChart(this, 'chartContainer')">
                <button class="btn-close-expand" onclick="closeChart(event, this)">✕</button>
                <span class="card-label">Timeline</span>
                <div class="chart-box"><canvas id="barChart"></canvas></div>
            </div>
            <div class="expand-item" onclick="expandChart(this, 'chartContainer')">
                <button class="btn-close-expand" onclick="closeChart(event, this)">✕</button>
                <span class="card-label">Arus Kas</span>
                <div class="chart-box"><canvas id="lineChart"></canvas></div>
            </div>
        </div>
    </div>

    <div class="quick-actions-wrap" id="quickActionsContainer"></div>

    <div class="section-header" style="cursor: default;">
        <div style="display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1;" onclick="toggleSection('historySection', 'historyToggleIcon')">
            <h2 class="section-title">Riwayat Transaksi</h2>
            <svg id="historyToggleIcon" class="toggle-icon rotated" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
        </div>
        <button onclick="openCSVModal()" style="background:transparent; border:1px solid var(--hijau); color:var(--hijau); padding:6px 10px; border-radius:8px; font-size:11px; font-weight:800; cursor:pointer; display:flex; gap:6px; align-items:center; text-transform:uppercase;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export CSV
        </button>
    </div>
    
    <div id="debtBannerContainer"></div>
    <div class="collapsible-content" id="historySection">
        <div class="search-container">
            <input type="text" id="searchTxInput" class="search-input" placeholder="Cari transaksi, kategori, atau nama peminjam..." autocomplete="off">
            <span class="search-clear" id="searchClearBtn" onclick="clearSearch()">✕</span>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Waktu</th><th>Kategori</th><th>Deskripsi/Peminjam</th><th style="text-align: right;">Nominal</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
    <div class="modal-overlay" id="profileViewModal">
        <div class="modal-card">
            <div style="text-align: center; margin-bottom: 25px; position: relative;">
                <div class="profile-pic-container" style="width: 80px; height: 80px; margin: 0 auto 10px auto; border-color:var(--putih);">
                    <img src="" id="viewProfileImg" class="profile-pic">
                </div>
                <h2 style="margin:0; font-size: 26px; font-weight:900;" id="viewProfileName">Guest</h2>
                <p style="margin:5px 0 0 0; font-size: 11px; color: var(--text-muted); font-weight:700;" id="viewJoinDate"></p>
                <button onclick="requestProfileEdit()" style="position: absolute; top: 0; right: 0; background:var(--hitam); border:1px solid var(--border); color:var(--text-muted); padding:10px; border-radius:10px; cursor:pointer;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
            </div>
            
            <div class="prof-detail-grid">
                <div class="prof-detail-box"><span class="prof-detail-label">Gender</span><p class="prof-detail-val" id="viewGender">-</p></div>
                <div class="prof-detail-box"><span class="prof-detail-label">Tgl Lahir</span><p class="prof-detail-val" id="viewBirth">-</p></div>
                <div class="prof-detail-box"><span class="prof-detail-label">Total Pemasukan</span><p class="prof-detail-val text-hijau" id="viewTotalMasuk">Rp 0</p></div>
                <div class="prof-detail-box"><span class="prof-detail-label">Total Pengeluaran</span><p class="prof-detail-val text-merah" id="viewTotalKeluar">Rp 0</p></div>
                
                <div class="prof-detail-box" style="grid-column: span 2; display:flex; justify-content:space-between; align-items:center; border-color:#4285F4; gap: 10px;">
                    <div style="text-align: left; flex: 1; min-width: 0;">
                        <span class="prof-detail-label">Status Akun</span>
                        <p class="prof-detail-val" id="viewGoogleStatus" style="color:var(--text-muted); font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Tidak Terhubung</p>
                    </div>
                    <button id="btnGoogleLink" class="btn-quick glow-biru" style="padding: 8px 12px; font-size:11px; border-color:#4285F4; color:#4285F4; flex-shrink: 0;" onclick="openGoogleAuthModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z"/></svg> 
                        <span id="textGoogleLink">Hubungkan</span>
                    </button>
                </div>
            </div>

            <div style="margin-bottom: 25px;">
                <span class="prof-detail-label" style="text-align: center; margin-bottom: 10px;">Support Developer</span>
                <div style="display: flex; gap: 10px;">
                    <a href="https://www.instagram.com/daengtio_?igsh=MXY4dTVhMGEzNDJxZA==" target="_blank" class="btn-sosmed ig">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                        Instagram
                    </a>
                    <a href="https://www.tiktok.com/@daengtio_0?_r=1&_t=ZS-94Cu2soiSXJ" target="_blank" class="btn-sosmed tt">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
                        TikTok
                    </a>
                </div>
            </div>
            
            <button class="btn-modal" onclick="initResetSequence()" style="background: transparent; border: 1px solid var(--merah); color: var(--merah); margin-bottom: 10px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: text-bottom; margin-right: 5px;"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                Reset Semua Data
            </button>
            <button class="btn-modal btn-cancel" onclick="closeModal('profileViewModal')">Tutup</button>
        </div>
    </div>

    <div class="modal-overlay" id="profileEditModal">
        <div class="modal-card">
            <h2 style="margin-top:0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Edit Profil</h2>
            
            <div style="text-align: center; margin-bottom: 25px;">
                <div class="profile-pic-container" style="width: 80px; height: 80px; margin: 0 auto 10px auto; border-color: var(--kuning);">
                    <img src="" id="editProfileImg" class="profile-pic">
                </div>
                <button type="button" onclick="document.getElementById('profileUploader').click()" style="background: var(--hitam-card); border: 1px solid var(--border); color: var(--putih); padding: 8px 16px; border-radius: 8px; font-size: 11px; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                    Pilih Foto Galeri
                </button>
                <input type="file" id="profileUploader" accept="image/*" class="visually-hidden">
            </div>
            <label class="input-label">Nama Lengkap</label>
            <input type="text" id="editName" class="input-field" placeholder="Nama Anda" autocomplete="off">
            
            <label class="input-label">Gender</label>
            <div class="custom-select-wrapper">
                <div class="custom-select-trigger" onclick="toggleCustomSelect('genderOptions')">
                    <span id="dispGenderVal">Pilih Gender</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                </div>
                <div class="custom-options" id="genderOptions">
                    <div class="custom-option" onclick="selectGender('Laki-Laki')">Laki-Laki</div>
                    <div class="custom-option" onclick="selectGender('Perempuan')">Perempuan</div>
                    <div class="custom-option" onclick="selectGender('Rahasia')">Rahasia</div>
                </div>
            </div>
            <input type="hidden" id="editGender">

            <label class="input-label">Tanggal Lahir (Ketik Angka Saja)</label>
            <input type="text" id="editBirth" class="input-field" placeholder="DD/MM/YYYY" inputmode="numeric" autocomplete="off">
            
            <label class="input-label text-kuning">Security PIN (Wajib untuk Reset)</label>
            <input type="password" id="editPin" class="input-field" placeholder="Ketik PIN untuk kunci profil" inputmode="numeric" maxlength="6" style="border-color:var(--kuning);">

            <button class="btn-modal" onclick="saveProfileData()">Simpan Perubahan</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('profileEditModal')">Batal</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="pinAuthModal">
        <div class="modal-card" style="max-width: 320px; text-align: center;">
            <h2 style="margin-top:0;">Otorisasi Profil</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 25px;">Masukkan PIN keamanan Anda untuk mengedit profil.</p>
            <input type="password" id="inputAuthPin" class="input-field" placeholder="****" inputmode="numeric" maxlength="6" style="text-align: center; font-size: 26px; letter-spacing: 8px; margin-bottom: 10px;">
            <button class="btn-modal" onclick="verifyPinAuth('edit')">Verifikasi PIN</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('pinAuthModal')">Batal</button>
            <div style="margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 10px;">
                <button class="btn-modal btn-cancel" style="color: var(--biru); font-size: 11px; padding: 10px; border: none;" onclick="startOTPResetProcess()">Lupa PIN? Kirim Kode ke Email</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="resetPinModal">
        <div class="modal-card" style="max-width: 320px; text-align: center;">
            <h2 style="margin-top:0; color: var(--merah);">Otorisasi Reset</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 25px;">Masukkan PIN keamanan Anda untuk mereset data.</p>
            <input type="password" id="inputResetPin" class="input-field" placeholder="****" inputmode="numeric" maxlength="6" style="text-align: center; font-size: 26px; letter-spacing: 8px; border-color: var(--merah); margin-bottom: 10px;">
            <button class="btn-modal" style="background: var(--merah);" onclick="verifyPinAuth('reset')">Verifikasi PIN</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('resetPinModal')">Batal</button>
            <div style="margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 10px;">
                <button class="btn-modal btn-cancel" style="color: var(--biru); font-size: 11px; padding: 10px; border: none;" onclick="startOTPResetProcess()">Lupa PIN? Kirim Kode ke Email</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="resetConfirmModal">
        <div class="modal-card" style="text-align:center; border-color: var(--merah);">
            <div style="background: rgba(239, 68, 68, 0.1); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; color: var(--merah);">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </div>
            <h2 style="margin-top:0; color: var(--merah);">PERINGATAN FATAL</h2>
            <p style="color:var(--text-muted); font-size:14px; margin-bottom: 25px;">Seluruh data transaksi, saldo, dan riwayat di server akan <b>dihapus permanen</b>. Tindakan ini tidak dapat dibatalkan!</p>
            <button class="btn-modal" style="background: var(--merah); color: white;" onclick="executeFactoryReset()">Saya Yakin (Hapus)</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('resetConfirmModal')">Batalkan</button>
        </div>
    </div>

    <div class="modal-overlay" id="txPinModal">
        <div class="modal-card" style="max-width: 320px; text-align: center;">
            <h2 style="margin-top:0; color: var(--kuning);" id="txPinTitle">Sandi Transaksi</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 25px;" id="txPinDesc">Masukkan sandi khusus untuk menyetujui pelunasan.</p>
            <input type="password" id="inputTxPin" class="input-field" placeholder="****" inputmode="numeric" maxlength="6" style="text-align: center; font-size: 26px; letter-spacing: 8px; border-color: var(--kuning); margin-bottom: 10px;" autocomplete="off">
            <button class="btn-modal" style="background: var(--kuning); color: var(--hitam);" id="btnVerifyTxPin" onclick="verifyTxPin()">Konfirmasi</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('txPinModal')">Batal</button>
            <div style="margin-top: 20px; border-top: 1px dashed var(--border); padding-top: 15px;">
                <button class="btn-modal btn-cancel" style="color: var(--merah); font-size: 11px; padding: 10px; border: none;" onclick="openResetTxPinModal()">Reset Sandi Transaksi</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="resetTxPinAuthModal">
        <div class="modal-card" style="max-width: 320px; text-align: center;">
            <div style="background: rgba(239, 68, 68, 0.1); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; color: var(--merah);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            </div>
            <h2 style="margin-top:0; color: var(--merah); font-size: 20px;">Otorisasi Reset</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">Masukkan <b>PIN Profil</b> utama Anda untuk mereset Sandi Transaksi.</p>
            <input type="password" id="inputResetTxAuthPin" class="input-field" placeholder="****" inputmode="numeric" maxlength="6" style="text-align: center; font-size: 26px; letter-spacing: 8px; border-color: var(--merah); margin-bottom: 10px;" autocomplete="off">
            <button class="btn-modal" style="background: var(--merah);" onclick="executeResetTxPin()">Verifikasi & Reset</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('resetTxPinAuthModal')">Batal</button>
            <div style="margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 10px;">
                <button class="btn-modal btn-cancel" style="color: var(--biru); font-size: 11px; padding: 10px; border: none;" onclick="startOTPResetProcess()">Lupa PIN? Kirim Kode ke Email</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="googleAuthModal">
        <div class="modal-card" style="text-align: center;">
            <h2 style="margin-top:0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Sinkronisasi Cloud</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 25px;">Login untuk menyimpan data Anda dengan aman ke server Supabase secara real-time.</p>
            <button class="btn-modal" id="btnRealGoogleLogin" style="display:flex; align-items:center; justify-content:center; gap:10px; background:#fff; color:#000; padding:15px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z"/></svg> 
                Login dengan Google
            </button>
            <button class="btn-modal btn-cancel" onclick="closeModal('googleAuthModal')" style="margin-top: 15px;">Batal</button>
        </div>
    </div>

    <div class="modal-overlay" id="csvExportModal">
        <div class="modal-card" style="text-align: center;">
            <div style="background: rgba(16, 185, 129, 0.1); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; color: var(--hijau);">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            </div>
            <h2 style="margin-top:0; color: var(--hijau);">Ekspor Laporan CSV</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 25px;">Data yang diekspor akan menyesuaikan dengan <b>filter waktu</b> yang sedang aktif di halaman utama.</p>
            
            <button class="btn-modal" style="background: var(--hijau); color: var(--hitam);" onclick="executeCSVExport()">Unduh Sekarang</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('csvExportModal')">Batal</button>
        </div>
    </div>

    <div class="modal-overlay" id="txModal">
        <div class="modal-card">
            <h2 id="modal-title" style="margin-top:0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Input Data</h2>
            <input type="hidden" id="tx-type">
            <input type="hidden" id="tx-is-saving" value="false">
            
            <label class="input-label" id="label-kategori">Kategori</label>
            <div id="categoryContainer" style="margin-bottom: 20px; position: relative;">
                <div class="custom-select-wrapper" id="catSelectWrapper" style="margin-bottom: 0;">
                    <div class="custom-select-trigger" onclick="toggleCustomSelect('catOptionsBox')">
                        <span id="dispTxCat">Pilih Kategori</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                    <div class="custom-options" id="catOptionsBox"></div>
                </div>
                <input type="text" id="tx-category-manual" class="input-field" placeholder="Ketik kategori / nama manual..." style="margin:0; display: none;">
            </div>
            
            <input type="hidden" id="tx-category">

            <div id="borrowerWrapper" style="display: none;">
                <label class="input-label text-kuning">Nama Peminjam</label>
                <input type="text" id="tx-borrower" class="input-field" placeholder="Ketik nama peminjam..." autocomplete="off">
            </div>

            <label class="input-label" id="label-desc">Deskripsi</label>
            <input type="text" id="tx-desc" class="input-field" autocomplete="off">
            
            <label class="input-label">Nominal (Rp)</label>
            <input type="text" id="tx-amount" class="input-field text-kuning" inputmode="numeric" placeholder="0" autocomplete="off" style="font-size: 26px; font-weight: 900; text-align: right;">
            
            <button type="button" class="btn-modal" id="btnExecuteTx">Eksekusi Transaksi</button>
            <button type="button" class="btn-modal btn-cancel" onclick="closeModal('txModal')">Batal</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-card" style="text-align:center;">
            <h2 style="margin-top:0;" id="confirmTitle">Konfirmasi</h2>
            <p id="confirmDesc" style="color:var(--text-muted); font-size:14px; line-height: 1.5; margin-bottom: 25px;">Apakah Anda yakin?</p>
            <button class="btn-modal" id="btnConfirmYes">Ya, Lanjutkan</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('confirmModal')">Batal</button>
        </div>
    </div>

    <div class="modal-overlay" id="receiptModal">
        <div class="modal-card" style="background: #0f172a;">
            <div class="receipt-card" id="receiptContent">
            </div>
            <button class="btn-modal btn-cancel" onclick="closeModal('receiptModal')" style="border-color: #334155; color: #94a3b8; margin-top: 15px;">Tutup Bukti Transaksi</button>
        </div>
    </div>

    <div class="modal-overlay" id="otpRequestModal">
        <div class="modal-card" style="text-align: center;">
            <div style="background: rgba(59, 130, 246, 0.1); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; color: var(--biru);">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </div>
            <h2 style="margin-top:0; color: var(--biru);">Reset PIN Terkunci</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 25px;">Kami akan mengirimkan kode rahasia 6-digit ke email Google Anda (<b id="displayUserEmail" style="color:var(--putih);"></b>).</p>
            <button class="btn-modal" style="background: var(--biru); color: white;" id="btnSendOTP" onclick="sendOTPEmail()">Kirim Kode Sekarang</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('otpRequestModal')">Batal</button>
        </div>
    </div>

    <div class="modal-overlay" id="otpVerifyModal">
        <div class="modal-card" style="text-align: center;">
            <h2 style="margin-top:0; color: var(--hijau);">Verifikasi Kode</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">Masukkan 6 digit kode dari email Anda.</p>
            <input type="number" id="inputOTP" class="input-field" placeholder="Kode OTP" style="text-align: center; font-size: 20px; letter-spacing: 5px; margin-bottom: 20px;">
            
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px;">Buat PIN Utama Baru Anda:</p>
            <input type="password" id="inputNewPinOTP" class="input-field" placeholder="PIN Baru (min 4 digit)" inputmode="numeric" maxlength="6" style="text-align: center; font-size: 20px; letter-spacing: 5px; margin-bottom: 20px;">
            
            <button class="btn-modal" style="background: var(--hijau); color: var(--hitam);" onclick="verifyOTPAndSavePin()">Verifikasi & Ganti PIN</button>
            <button class="btn-modal btn-cancel" onclick="closeModal('otpVerifyModal')">Batal</button>
        </div>
    </div>
    <script>
        // ==========================================
        // 1. SISTEM AUTO-UPDATE & SMART CACHE BUSTER
        // ==========================================
        const APP_VERSION = '21.0'; 
        
        function checkAppVersion() {
            const savedVersion = localStorage.getItem('finance_app_version');
            if (savedVersion !== APP_VERSION) {
                localStorage.setItem('finance_app_version', APP_VERSION);
                if (navigator.onLine) {
                    const updateScreen = document.getElementById('updateScreen');
                    if (updateScreen) {
                        updateScreen.style.display = 'flex';
                        // Paksa reload true agar bypass cache browser yang membandel
                        setTimeout(() => { window.location.reload(true); }, 1500);
                    }
                }
            }
        }
        checkAppVersion();

        // ==========================================
        // 2. VARIABEL GLOBAL & FLAG OFFLINE (ISOLASI BRANKAS)
        // ==========================================
        let sbClient = null;
        let db = []; 
        let pendingSync = JSON.parse(localStorage.getItem('finance_pending_sync')) || []; 
        let currentUser = null; 
        
        // FLAG SAKTI: Mengingat status login terakhir walau tanpa internet
        let wasLoggedIn = localStorage.getItem('finance_was_logged_in') === 'true';

        let activeWallet = 'harian'; 
        let currentTimeFilter = 365; 
        let rawAmount = 0;
        let pieChart, barChart, lineChart; 
        let pendingTxCallback = null;
        let aiMessages = []; 
        let aiCurrentMsgIdx = 0; 
        let aiCarouselInterval = null; 
        let realTimeSubscription = null;
        let generatedOTP = "";
        let otpExpiryTime = 0;

        const defaultProfile = { 
            name: 'Guest', pin: '', txPin: '',
            photo: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzFlMjliYiI+PHBhdGggZD0iTTEyIDJhNSA1IDAgMSAwIDUgNSBNMTIgMTRhNyA3IDAgMCAwLTcgN3YxSDE5di0xYTcgNyAwIDAgMC03LTdaIi8+PC9zdmc+', 
            joinDate: new Date().toISOString(), birthDate: '', gender: 'Rahasia', googleLinked: false, googleEmail: ''
        };
        let profile = JSON.parse(localStorage.getItem('user_profile_secure_v2')) || defaultProfile;

        // Data Kategori & SVGs
        const svgs = {
            makan: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            transport: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="7" cy="16" r="1"/><circle cx="17" cy="16" r="1"/><path d="M14 11V7a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v4"/></svg>`,
            uang: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>`,
            atm: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h12M6 12h2M10 12h2M14 12h2M6 16h6"/></svg>`,
            plus: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            pinjam: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3v3m-4-3v3M7 3v3m14 8H3m18 4H3m2-14h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2-2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2z"/></svg>`,
            check: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`
        };
        const categories = { masuk: ['Gaji', 'Top-Up', 'Bonus', 'Usaha'], keluar: ['Makan', 'Transport', 'Belanja', 'Tagihan'] };

        function getDynamicColor(categoryStr, type) {
            if (categoryStr === 'Pindah Tabungan') return '#f59e0b';
            if (categoryStr === 'Dari Tabungan') return '#10b981';
            if (categoryStr === 'Dipinjam') return '#a855f7';
            if (type === 'keluar') return '#ef4444';
            const inColors = { 'Top-Up': '#3b82f6', 'Gaji': '#10b981', 'Bonus': '#06b6d4', 'Usaha': '#8b5cf6', 'Lunas Pinjaman': '#10b981' };
            if (inColors[categoryStr]) return inColors[categoryStr];
            let hash = 0; for(let i = 0; i < categoryStr.length; i++) hash = categoryStr.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash) % 360}, 70%, 55%)`; 
        }

        // ==========================================
        // 3. SISTEM KEAMANAN & PENYIMPANAN LOKAL
        // ==========================================
        const SECRET_KEY = "F1n4nc3_App_S3cur3_K3y_99";

        function getDBKey() {
            // Isolasi murni: Guest punya loker sendiri, Cloud punya loker sendiri.
            return (currentUser || wasLoggedIn) ? 'finance_cloud_db_secure' : 'finance_guest_db_secure';
        }

        function saveLocalDB(dataToSave) {
            const dbKey = getDBKey();
            try {
                if (typeof CryptoJS !== 'undefined') {
                    const ciphertext = CryptoJS.AES.encrypt(JSON.stringify(dataToSave), SECRET_KEY).toString();
                    localStorage.setItem(dbKey, ciphertext);
                } else {
                    localStorage.setItem(dbKey + '_fallback', JSON.stringify(dataToSave));
                }
            } catch(e) { console.warn("Gagal simpan lokal:", e); }
        }

        function loadLocalDB(forceGuest = false) {
            const dbKey = forceGuest ? 'finance_guest_db_secure' : getDBKey();
            let data = [];
            try {
                const ciphertext = localStorage.getItem(dbKey);
                if (ciphertext) {
                    if (typeof CryptoJS !== 'undefined') {
                        data = JSON.parse(CryptoJS.AES.decrypt(ciphertext, SECRET_KEY).toString(CryptoJS.enc.Utf8)); 
                    }
                } else {
                    const fallback = localStorage.getItem(dbKey + '_fallback');
                    if (fallback) data = JSON.parse(fallback);
                }
            } catch (e) { console.warn("Gagal load lokal:", e); }
            return Array.isArray(data) ? data : [];
        }

        async function hashPIN(pin) {
            if (!pin) return '';
            try {
                if (window.crypto && window.crypto.subtle && window.isSecureContext) {
                    const msgBuffer = new TextEncoder().encode(pin);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                } else if (typeof CryptoJS !== 'undefined') {
                    return CryptoJS.SHA256(pin).toString(CryptoJS.enc.Hex);
                } else {
                    return btoa(pin); 
                }
            } catch (error) { return btoa(pin); }
        }

        function saveProfileLocal() {
            localStorage.setItem('user_profile_secure_v2', JSON.stringify(profile));
        }

        // ==========================================
        // 4. MESIN UTAMA (BOOT APP) - TRUE OFFLINE FIRST
        // ==========================================
        async function bootApp() {
            // EKSEKUSI RENDER UI SINKRONUS (INSTAN)
            if(typeof renderShortcuts === 'function') renderShortcuts(); 
            
            // JIKA SCRIPT CDN GAGAL DIMUAT KARENA OFFLINE EKSTREM
            if (typeof window.supabase === 'undefined') {
                if (wasLoggedIn) {
                    // Pura-pura login pakai dummy object agar UI mengira kita login
                    currentUser = { id: 'offline_user', email: profile.googleEmail || 'Offline User' };
                    db = loadLocalDB(false); // Paksa load cache Cloud
                    const netStatus = document.getElementById('networkStatus');
                    if(netStatus) { netStatus.innerText = "Offline Mode (Cloud)"; netStatus.className = "status-sync sync-offline"; }
                } else {
                    // Murni Guest
                    currentUser = null;
                    db = loadLocalDB(true); // Paksa load cache Guest
                    const netStatus = document.getElementById('networkStatus');
                    if(netStatus) { netStatus.innerText = "Offline Mode (Guest)"; netStatus.className = "status-sync sync-offline"; }
                }
                
                initAppHeader();
                if(typeof updateUI === 'function') updateUI('');
                return; // STOP DI SINI AGAR TIDAK CRASH MENCARI FUNGSI SUPABASE
            }

            // JIKA ONLINE / CDN TERSEDIA
            const supabaseUrl = 'https://kkbfppuxuwcbapexlqsx.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrYmZwcHV4dXdjYmFwZXhscXN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDMwODAsImV4cCI6MjA4NzU3OTA4MH0.pOGHpiR333Ltp2g3BQvV8xSMbdbMeRMHJ3ZgecHDRzM';
            sbClient = window.supabase.createClient(supabaseUrl, supabaseKey);

            // Cek Session tanpa memblokir UI terlalu lama
            const { data: { session } } = await sbClient.auth.getSession();
            
            if (session && session.user) {
                currentUser = session.user;
                localStorage.setItem('finance_was_logged_in', 'true');
                wasLoggedIn = true;
                
                db = loadLocalDB(false); // Render cache lokal dulu biar cepat
                initAppHeader();
                
                const netStatus = document.getElementById('networkStatus');
                if(netStatus) { netStatus.innerText = navigator.onLine ? "Online Mode (Cloud)" : "Offline Mode (Cloud)"; netStatus.className = navigator.onLine ? "status-sync sync-online" : "status-sync sync-offline"; }
                
                // Fetch data real-time di background
                fetchUserTransactions(); 
                setupRealtime();
                
                if (navigator.onLine && pendingSync.length > 0) processPendingSync();
            } else {
                currentUser = null;
                localStorage.setItem('finance_was_logged_in', 'false');
                wasLoggedIn = false;
                
                db = loadLocalDB(true); // Render cache Guest lokal
                initAppHeader();
                
                const netStatus = document.getElementById('networkStatus');
                if(netStatus) { netStatus.innerText = navigator.onLine ? "Online Mode (Guest)" : "Offline Mode (Guest)"; netStatus.className = navigator.onLine ? "status-sync sync-online" : "status-sync sync-offline"; }
            }
            
            if(typeof updateUI === 'function') updateUI('');

            // LISTENER LOGIN/LOGOUT DARI SUPABASE
            sbClient.auth.onAuthStateChange(async (event, currentSession) => {
                if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    localStorage.setItem('finance_was_logged_in', 'false');
                    wasLoggedIn = false;
                    
                    profile.googleLinked = false; 
                    profile.googleEmail = '';
                    db = loadLocalDB(true); // Langsung pindah ke brankas Guest
                    
                    initAppHeader();
                    if(typeof renderShortcuts === 'function') renderShortcuts(); 
                    if(typeof updateUI === 'function') updateUI('');
                    
                    showToast("Berhasil Logout. Mode Guest.", "success");
                    closeModal('profileViewModal');
                    
                    const netStatus = document.getElementById('networkStatus');
                    if(netStatus) { netStatus.innerText = navigator.onLine ? "Online Mode (Guest)" : "Offline Mode (Guest)"; netStatus.className = navigator.onLine ? "status-sync sync-online" : "status-sync sync-offline"; }
                } else if (event === 'SIGNED_IN' && currentSession) {
                    currentUser = currentSession.user; 
                    localStorage.setItem('finance_was_logged_in', 'true');
                    wasLoggedIn = true;
                    
                    const netStatus = document.getElementById('networkStatus');
                    if(netStatus) { netStatus.innerText = navigator.onLine ? "Online Mode (Cloud)" : "Offline Mode (Cloud)"; netStatus.className = navigator.onLine ? "status-sync sync-online" : "status-sync sync-offline"; }
                    
                    try {
                        const { data: profileData } = await sbClient.from('profiles').select('data').eq('id', currentUser.id).single();
                        if (profileData && profileData.data) { profile = { ...profile, ...profileData.data }; } 
                        else { 
                            if(profile.name === 'Guest') profile.name = properTitleCase(currentUser.user_metadata?.full_name) || 'Member'; 
                            profile.photo = currentUser.user_metadata?.avatar_url || profile.photo; 
                            await saveProfileToSupabase(); 
                        }
                    } catch(e) {}
                    
                    profile.googleLinked = true; profile.googleEmail = currentUser.email; 
                    
                    db = loadLocalDB(false); // Pindah ke brankas Cloud
                    initAppHeader(); 
                    if(typeof renderShortcuts === 'function') renderShortcuts(); 
                    fetchUserTransactions(); 
                    setupRealtime();
                    closeModal('googleAuthModal');
                    
                    if (navigator.onLine && pendingSync.length > 0) processPendingSync();
                }
            });

            if (typeof window.emailjs !== 'undefined') { window.emailjs.init("qcqCpH81lqwQKw_MG"); }
        }
        // ==========================================
        // 5. DETEKSI JARINGAN KETAT (ANTI-FREEZE)
        // ==========================================
        window.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.modal-overlay.active').forEach(el => el.classList.remove('active'));
            if (navigator.onLine && pendingSync.length > 0) { setTimeout(processPendingSync, 3000); }
        });

        window.addEventListener('online', () => { 
            const netStatus = document.getElementById('networkStatus');
            if(netStatus) { 
                netStatus.innerText = wasLoggedIn ? "Online Mode (Cloud)" : "Online Mode (Guest)"; 
                netStatus.className = "status-sync sync-online"; 
            }
            if(pendingSync.length > 0) { processPendingSync(); } 
            else if(typeof fetchUserTransactions === 'function' && wasLoggedIn && currentUser && currentUser.id !== 'offline_user') { 
                fetchUserTransactions(); 
            }
        });
        
        window.addEventListener('offline', () => { 
            const netStatus = document.getElementById('networkStatus');
            if(netStatus) { 
                netStatus.innerText = pendingSync.length > 0 ? "Offline (Menunggu Sync)" : (wasLoggedIn ? "Offline Mode (Cloud)" : "Offline Mode (Guest)"); 
                netStatus.className = pendingSync.length > 0 ? "status-sync sync-pending" : "status-sync sync-offline"; 
            }
            showToast("Koneksi terputus. Mode Offline Aktif.", "error");
            if(typeof updateUI === 'function') updateUI(document.getElementById('searchTxInput') ? document.getElementById('searchTxInput').value : '');
        });

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'visible') { 
                if (navigator.onLine && pendingSync.length > 0) { processPendingSync(); } 
            }
        });

        // ==========================================
        // 6. FORMATTER & UTILITY SAKTI
        // ==========================================
        function formatRp(num) { 
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num); 
        }

        function formatRpPendek(num) {
            let str = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
            return str.replace(/\.000$/, '...');
        }

        function formatDetailDate(iso) { if(!iso) return '-'; const d = new Date(iso); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} - ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`; }
        function showToast(msg, type = 'success') { const box = document.getElementById('toastBox'); if(!box) return; const t = document.createElement('div'); t.className = `toast ${type}`; t.innerText = msg; box.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000); }
        function closeModal(id) { const el = document.getElementById(id); if(el) el.classList.remove('active'); document.querySelectorAll('.custom-options.open').forEach(e => e.classList.remove('open')); }
        function properTitleCase(str) { if(!str) return ""; return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase()); }

        let confirmAction = null;
        function openCustomConfirm(title, desc, action) { document.getElementById('confirmTitle').innerText = title; document.getElementById('confirmDesc').innerHTML = desc; confirmAction = action; document.getElementById('confirmModal').classList.add('active'); }
        document.getElementById('btnConfirmYes').addEventListener('click', () => { if(confirmAction) confirmAction(); closeModal('confirmModal'); });

        // ==========================================
        // 7. PROFIL, KEAMANAN PIN & GOOGLE AUTH
        // ==========================================
        function initAppHeader() { 
            document.getElementById('headName').innerText = profile.name; 
            document.getElementById('headGender').innerText = profile.gender; 
            document.getElementById('headProfileImg').src = profile.photo; 
        }

        async function saveProfileToSupabase() { 
            if (!currentUser || currentUser.id === 'offline_user' || !navigator.onLine || !sbClient) return; 
            try { await sbClient.from('profiles').upsert({ id: currentUser.id, data: profile }); } catch(e) {} 
        }

        function promptTxPin(callback) { 
            pendingTxCallback = callback; 
            const input = document.getElementById('inputTxPin'); input.value = ''; 
            if (!profile.txPin) { 
                document.getElementById('txPinTitle').innerText = "Buat Sandi Transaksi"; 
                document.getElementById('txPinDesc').innerText = "Buat sandi khusus untuk pelunasan."; 
                document.getElementById('btnVerifyTxPin').innerText = "Simpan & Lanjut"; 
            } else { 
                document.getElementById('txPinTitle').innerText = "Sandi Transaksi"; 
                document.getElementById('txPinDesc').innerText = "Masukkan sandi transaksi Anda."; 
                document.getElementById('btnVerifyTxPin').innerText = "Konfirmasi"; 
            } 
            document.getElementById('txPinModal').classList.add('active'); setTimeout(() => input.focus(), 300); 
        }

        async function verifyTxPin() { 
            const val = document.getElementById('inputTxPin').value; 
            if (val.length < 4) { showToast("Sandi min 4 digit", "error"); return; } 
            const hashedVal = await hashPIN(val); 
            if (!profile.txPin) { 
                profile.txPin = hashedVal; saveProfileLocal(); await saveProfileToSupabase(); showToast("Sandi Dibuat!", "success"); 
            } else { 
                if (hashedVal !== profile.txPin) { showToast("Sandi Salah!", "error"); return; } 
            } 
            closeModal('txPinModal'); if (pendingTxCallback) { pendingTxCallback(); pendingTxCallback = null; } 
        }

        function openResetTxPinModal() { 
            closeModal('txPinModal'); 
            if (!profile.pin) { showToast("Buat PIN Profil utama dulu.", "error"); return; } 
            const input = document.getElementById('inputResetTxAuthPin'); input.value = ''; 
            document.getElementById('resetTxPinAuthModal').classList.add('active'); setTimeout(() => input.focus(), 300); 
        }

        async function executeResetTxPin() { 
            const pin = document.getElementById('inputResetTxAuthPin').value; 
            const hashedPin = await hashPIN(pin); 
            if (hashedPin === profile.pin) { 
                profile.txPin = ''; saveProfileLocal(); await saveProfileToSupabase(); showToast("Sandi Direset!"); 
                closeModal('resetTxPinAuthModal'); promptTxPin(pendingTxCallback); 
            } else { showToast("PIN Salah!", "error"); } 
        }

        document.getElementById('btnRealGoogleLogin').addEventListener('click', async () => { 
            if(typeof window.supabase === 'undefined' || !sbClient || !navigator.onLine) { showToast("Mode Offline. Tidak bisa Login.", "error"); return; }
            if(!currentUser && db.length > 0) localStorage.setItem('pending_guest_data', JSON.stringify(db)); 
            const { error } = await sbClient.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin + window.location.pathname } }); 
            if (error) showToast("Gagal Login", "error"); 
        });

        function openProfileView() { 
            let inT = 0, outT = 0; db.forEach(t => { if(t.type === 'masuk') inT += t.amount; else outT += t.amount; }); 
            document.getElementById('viewProfileImg').src = profile.photo; 
            document.getElementById('viewProfileName').innerText = profile.name; 
            document.getElementById('viewJoinDate').innerText = "Bergabung: " + formatDetailDate(profile.joinDate); 
            document.getElementById('viewGender').innerText = profile.gender || '-'; 
            document.getElementById('viewBirth').innerText = profile.birthDate || '-'; 
            document.getElementById('viewTotalMasuk').innerText = formatRp(inT); 
            document.getElementById('viewTotalKeluar').innerText = formatRp(outT); 
            
            const stat = document.getElementById('viewGoogleStatus'); 
            const btnText = document.getElementById('textGoogleLink'); 
            const btn = document.getElementById('btnGoogleLink'); 
            
            // Cek apakah mode Cloud (baik online maupun offline)
            if(wasLoggedIn || (currentUser && currentUser.id !== 'offline_user')) { 
                stat.innerHTML = `<span style="color:var(--hijau); font-weight:700;">${profile.googleEmail || (currentUser ? currentUser.email : 'Cloud User')}</span>`; 
                btnText.innerText = "Logout"; btn.style.borderColor = "var(--merah)"; btn.style.color = "var(--merah)"; 
                btn.onclick = async () => { 
                    openCustomConfirm("Logout Akun", "Logout ke mode Guest? Data Cloud aman di server.", async () => { 
                        if(sbClient && navigator.onLine) {
                            await sbClient.auth.signOut(); 
                        } else { 
                            // LOGOUT OFFLINE MURNI (Isolasi Storage)
                            currentUser = null;
                            wasLoggedIn = false;
                            localStorage.setItem('finance_was_logged_in', 'false');
                            db = loadLocalDB(true); // Pindah ke brankas Guest (kosong/lokal)
                            initAppHeader();
                            if(typeof updateUI === 'function') updateUI('');
                            closeModal('profileViewModal');
                            showToast("Logout Paksa (Offline). Mode Guest.", "success");
                            const netStatus = document.getElementById('networkStatus');
                            if(netStatus) { netStatus.innerText = "Offline Mode (Guest)"; netStatus.className = "status-sync sync-offline"; }
                        }
                    }); 
                }; 
            } else { 
                stat.innerText = "Tidak Terhubung"; stat.style.color = "var(--text-muted)"; 
                btnText.innerText = "Hubungkan"; btn.style.borderColor = "#4285F4"; btn.style.color = "#4285F4"; 
                btn.onclick = openGoogleAuthModal; 
            } 
            document.getElementById('profileViewModal').classList.add('active'); 
        }
        
        function openGoogleAuthModal() { document.getElementById('googleAuthModal').classList.add('active'); }
        function requestProfileEdit() { if(profile.pin && profile.pin !== '') { closeModal('profileViewModal'); document.getElementById('inputAuthPin').value = ''; document.getElementById('pinAuthModal').classList.add('active'); } else { openProfileEdit(); } }
        function initResetSequence() { if (!profile.pin || profile.pin.trim() === '') { showToast("Buat PIN di Edit Profil.", "error"); return; } closeModal('profileViewModal'); document.getElementById('inputResetPin').value = ''; document.getElementById('resetPinModal').classList.add('active'); }
        
        async function verifyPinAuth(actionType) { 
            const inputVal = document.getElementById(actionType === 'edit' ? 'inputAuthPin' : 'inputResetPin').value; 
            const hashedInput = await hashPIN(inputVal); 
            if (hashedInput === profile.pin) { 
                if (actionType === 'edit') { closeModal('pinAuthModal'); openProfileEdit(); } 
                else if (actionType === 'reset') { closeModal('resetPinModal'); document.getElementById('resetConfirmModal').classList.add('active'); } 
            } else { showToast("PIN Salah!", "error"); } 
        }
        
        function openProfileEdit() { document.getElementById('editProfileImg').src = profile.photo; document.getElementById('editName').value = profile.name !== 'Guest' ? profile.name : ''; selectGender(profile.gender); document.getElementById('editBirth').value = profile.birthDate; document.getElementById('editPin').value = ''; document.getElementById('profileEditModal').classList.add('active'); }
        
        document.getElementById('profileUploader').addEventListener('change', function(e) { 
            const f = e.target.files[0]; if(!f) return; showToast("Mengompresi foto...", "success"); const reader = new FileReader(); 
            reader.onload = function(evt) { 
                const img = new Image(); 
                img.onload = function() { 
                    const canvas = document.createElement('canvas'); const MAX_WIDTH = 400; const MAX_HEIGHT = 400; let width = img.width; let height = img.height; 
                    if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } } 
                    canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); 
                    profile.photo = canvas.toDataURL('image/jpeg', 0.6); document.getElementById('editProfileImg').src = profile.photo; 
                }; img.src = evt.target.result; 
            }; reader.readAsDataURL(f); 
        });

        document.getElementById('editBirth').addEventListener('input', function(e) { 
            let v = e.target.value.replace(/\D/g, ''); if (v.length > 8) v = v.substring(0, 8); let hari = v.substring(0, 2); let bulan = v.substring(2, 4); let tahun = v.substring(4, 8); 
            if (hari.length === 2 && parseInt(hari) > 31) hari = '31'; if (hari.length === 2 && parseInt(hari) === 0) hari = '01'; if (bulan.length === 2 && parseInt(bulan) > 12) bulan = '12'; if (bulan.length === 2 && parseInt(bulan) === 0) bulan = '01'; 
            let finalFormat = hari; if (v.length >= 3) finalFormat += '/' + bulan; if (v.length >= 5) finalFormat += '/' + tahun; e.target.value = finalFormat; 
        });
        
        async function saveProfileData() { 
            profile.name = properTitleCase(document.getElementById('editName').value.trim()) || 'Guest'; 
            profile.gender = document.getElementById('editGender').value; 
            profile.birthDate = document.getElementById('editBirth').value; 
            const rawPin = document.getElementById('editPin').value; 
            if (rawPin && rawPin.trim() !== '') { profile.pin = await hashPIN(rawPin); } 
            saveProfileLocal(); initAppHeader(); closeModal('profileEditModal'); showToast("Profil Disimpan"); saveProfileToSupabase(); 
        }
        
        async function executeFactoryReset() { 
            showToast("Memulai format...", "syncing"); 
            db = [];
            const dbKey = getDBKey();
            localStorage.removeItem(dbKey);
            localStorage.removeItem(dbKey + '_fallback');
            
            try { 
                if (currentUser && currentUser.id !== 'offline_user' && navigator.onLine && sbClient) { 
                    const { error } = await sbClient.from('transactions').delete().eq('user_id', currentUser.id); 
                    if (error) throw error; 
                }
                showToast("Database musnah.", "success"); 
            } catch (e) { showToast("Direset Lokal Saja.", "error"); } 
            closeModal('resetConfirmModal'); updateUI(document.getElementById('searchTxInput') ? document.getElementById('searchTxInput').value : ''); 
        }
        // ==========================================
        // 8. KONTROL UI MURNI (INTERAKTIF & ANIMASI UTUH)
        // ==========================================
        function switchWallet(type) { activeWallet = type; document.getElementById('walletSwitchContainer').setAttribute('data-active', type); renderShortcuts(); updateUI(document.getElementById('searchTxInput') ? document.getElementById('searchTxInput').value : ''); }
        function toggleCustomSelect(id) { const box = document.getElementById(id); const isOpen = box.classList.contains('open'); document.querySelectorAll('.custom-options.open').forEach(el => el.classList.remove('open')); if(!isOpen) box.classList.add('open'); }
        function applyTimeFilter(days, labelText) { currentTimeFilter = days; document.getElementById('dispTimeFilter').innerText = labelText; closeModal(''); updateUI(document.getElementById('searchTxInput') ? document.getElementById('searchTxInput').value : ''); }
        function selectGender(val) { document.getElementById('editGender').value = val; document.getElementById('dispGenderVal').innerText = val; closeModal(''); }
        function selectCategory(val) { document.getElementById('tx-category').value = val; document.getElementById('dispTxCat').innerText = val; closeModal(''); }
        function toggleSection(sec, icn) { document.getElementById(sec).classList.toggle('hidden'); document.getElementById(icn).classList.toggle('rotated'); }
        
        function openCSVModal() { if(db.length === 0) { showToast("Data kosong.", "error"); return; } document.getElementById('csvExportModal').classList.add('active'); }
        function executeCSVExport() { 
            closeModal('csvExportModal'); let csv = "Tanggal,Dompet,Tipe,Kategori,Deskripsi,Peminjam,Nominal,Status\n"; 
            const today = new Date(); today.setHours(0,0,0,0);
            const filteredData = db.filter(tx => { if(tx.wallet !== activeWallet) return false; if(currentTimeFilter !== 0) { const d = new Date(tx.date); d.setHours(0,0,0,0); if(Math.floor(Math.abs(today - d) / 86400000) > currentTimeFilter) return false; } return true; });
            if(filteredData.length === 0) { showToast("Data filter kosong.", "error"); return; }
            [...filteredData].sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(row => { let r = [formatDetailDate(row.date), row.wallet, row.type, row.category, row.desc, row.borrower||'-', row.amount, row.status]; csv += r.map(v => `"${v}"`).join(",") + "\n"; }); 
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Laporan_${activeWallet.toUpperCase()}_${new Date().toISOString().split('T')[0]}.csv`; 
            document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast("CSV Berhasil Diunduh", "success"); 
        }

        // FUNGSI RENDER SHORTCUT ASLI LU
        function renderShortcuts() { 
            const c = document.getElementById('quickActionsContainer'); 
            if(activeWallet === 'harian') { 
                c.className = 'quick-actions-wrap grid-mode grid-split-4'; 
                c.innerHTML = ` 
                    <button class="btn-quick glow-merah" onclick="quickInput('keluar', 'Makan', 'Beli Makan')">${svgs.makan} <span>Beli Makan</span></button> 
                    <button class="btn-quick glow-kuning" onclick="quickInput('keluar', 'Transport', 'Isi Bensin')">${svgs.transport} <span>Transport</span></button> 
                    <button class="btn-quick glow-biru" onclick="quickInput('masuk', 'Top-Up', 'Isi Saldo')">${svgs.uang} <span>Isi Saldo</span></button> 
                    <button class="btn-quick glow-ungu" onclick="quickInput('keluar', 'Dipinjam', 'Pinjamkan Uang', true)">${svgs.pinjam} <span>Dipinjam</span></button> 
                    <button class="btn-quick glow-kuning" onclick="quickInput('keluar', 'MANUAL', '')">${svgs.plus} <span>Lainnya (-)</span></button> 
                    <button class="btn-quick glow-hijau" onclick="quickInput('masuk', 'MANUAL', '')">${svgs.plus} <span>Lainnya (+)</span></button> 
                `; 
            } else { 
                c.className = 'quick-actions-wrap grid-mode grid-split-4'; 
                c.innerHTML = ` 
                    <button class="btn-quick glow-kuning" onclick="quickInput('masuk', 'Top-Up', 'Setor Tabungan')">${svgs.uang} <span>Setor Tunai</span></button> 
                    <button class="btn-quick glow-merah" onclick="quickInput('keluar', 'Pindah Harian', 'Tarik ke Dompet Harian')">${svgs.atm} <span>Tarik Harian</span></button> 
                    <button class="btn-quick glow-merah" onclick="quickInput('keluar', 'Lainnya', 'Tarik Tunai')">${svgs.atm} <span>Tarik Lainnya</span></button> 
                    <button class="btn-quick glow-ungu" onclick="quickInput('keluar', 'Dipinjam', 'Pinjamkan Uang', true)">${svgs.pinjam} <span>Dipinjam</span></button> 
                `; 
            } 
        }
        
        // EFEK EXPAND CARD & CHART ASLI LU (TIDAK ADA YANG DIBUANG)
        function toggleExpandStat(el, id) { 
            const items = document.getElementById(id).children; 
            if (el.classList.contains('expanded')) { for(let i of items) i.className = 'expand-item'; } 
            else { for(let i of items) i.className = (i === el) ? 'expand-item expanded' : 'expand-item collapsed'; } 
        } 
        
        function expandChart(el, id) { 
            if(!el.classList.contains('expanded')) { 
                for(let i of document.getElementById(id).children) i.className = (i === el) ? 'expand-item expanded' : 'expand-item collapsed'; 
                setTimeout(() => { if(typeof Chart !== 'undefined' && pieChart) pieChart.resize(); if(typeof Chart !== 'undefined' && barChart) barChart.resize(); if(typeof Chart !== 'undefined' && lineChart) lineChart.resize(); }, 100); 
                setTimeout(() => { if(typeof Chart !== 'undefined' && pieChart) pieChart.resize(); if(typeof Chart !== 'undefined' && barChart) barChart.resize(); if(typeof Chart !== 'undefined' && lineChart) lineChart.resize(); }, 550); 
            } 
        } 
        
        function closeChart(e, btn) { 
            e.stopPropagation(); 
            for(let i of btn.closest('.expand-container').children) i.className = 'expand-item'; 
            setTimeout(() => { if(typeof Chart !== 'undefined' && pieChart) pieChart.resize(); if(typeof Chart !== 'undefined' && barChart) barChart.resize(); if(typeof Chart !== 'undefined' && lineChart) lineChart.resize(); }, 100); 
            setTimeout(() => { if(typeof Chart !== 'undefined' && pieChart) pieChart.resize(); if(typeof Chart !== 'undefined' && barChart) barChart.resize(); if(typeof Chart !== 'undefined' && lineChart) lineChart.resize(); }, 550); 
        }

        // ==========================================
        // 9. INPUT TRANSAKSI & SMART ROUTING LOGIC (OFFLINE SAFE)
        // ==========================================
        let isLoanMode = false;
        function quickInput(type, cat, desc, isLoan = false) { 
            isLoanMode = isLoan; 
            document.getElementById('tx-type').value = type; 
            document.getElementById('modal-title').innerText = isLoan ? 'Catat Uang Dipinjam' : (type === 'masuk' ? 'Input Pemasukan' : 'Input Pengeluaran'); 
            document.getElementById('tx-desc').value = ''; 
            document.getElementById('tx-category-manual').value = ''; 
            document.getElementById('tx-borrower').value = ''; 
            
            if(cat === 'MANUAL') { 
                document.getElementById('catSelectWrapper').style.display = 'none'; 
                document.getElementById('tx-category-manual').style.display = 'block'; 
                document.getElementById('label-kategori').innerText = 'Ketik Nama Kategori'; 
            } else { 
                document.getElementById('catSelectWrapper').style.display = 'block'; 
                document.getElementById('tx-category-manual').style.display = 'none'; 
                document.getElementById('label-kategori').innerText = 'Kategori'; 
                const box = document.getElementById('catOptionsBox'); 
                const arr = type === 'masuk' ? categories.masuk : categories.keluar; 
                box.innerHTML = arr.map(c => `<div class="custom-option" onclick="selectCategory('${c}')">${c}</div>`).join(''); 
                if(!arr.includes(cat)) box.innerHTML += `<div class="custom-option" onclick="selectCategory('${cat}')">${cat}</div>`; 
                selectCategory(cat); 
            } 
            
            const bw = document.getElementById('borrowerWrapper'); 
            const lbDesc = document.getElementById('label-desc'); 
            if(isLoanMode) { 
                bw.style.display = 'block'; lbDesc.innerText = 'Deskripsi (Opsional)'; document.getElementById('tx-desc').value = 'Uang Dipinjamkan'; 
            } else { 
                bw.style.display = 'none'; lbDesc.innerText = 'Deskripsi'; document.getElementById('tx-desc').value = desc; 
            } 
            
            document.getElementById('tx-amount').value = ''; rawAmount = 0; 
            document.getElementById('txModal').classList.add('active'); 
            setTimeout(() => { 
                if(isLoanMode) document.getElementById('tx-borrower').focus(); 
                else if(cat === 'MANUAL') document.getElementById('tx-category-manual').focus(); 
                else document.getElementById('tx-amount').focus(); 
            }, 300); 
        }
        
        document.getElementById('tx-amount').addEventListener('input', function() { 
            let v = this.value.replace(/[^0-9]/g, ''); 
            if(v === '') { rawAmount = 0; this.value = ''; return; } 
            rawAmount = parseInt(v, 10); this.value = rawAmount.toLocaleString('id-ID'); 
        });
        
        function lunasiPinjaman(e, txId) { 
            e.stopPropagation(); 
            promptTxPin(() => { 
                const strTxId = String(txId); 
                const idx = db.findIndex(t => String(t.id) === strTxId || String(t.date) === strTxId); 
                if(idx > -1) { 
                    const tx = db[idx]; 
                    const targetWallet = tx.wallet; 
                    const walletName = targetWallet === 'harian' ? 'Dompet Harian' : 'Tabungan'; 
                    openCustomConfirm("Pelunasan Pinjaman", `Uang senilai <b>${formatRp(tx.amount)}</b> dari <b>${tx.borrower}</b> sudah lunas ke <b>${walletName}</b>?`, async () => { 
                        const deskripsiLunas = properTitleCase(`Lunas: ${tx.desc} (${tx.borrower})`); 
                        const lData = { wallet: targetWallet, type: 'masuk', category: 'Lunas Pinjaman', desc: deskripsiLunas, borrower: tx.borrower, amount: tx.amount, date: new Date().toISOString() }; 
                        
                        // Cek apakah login murni atau login offline
                        if(wasLoggedIn || (currentUser && currentUser.id !== 'offline_user')) {
                            if (navigator.onLine && sbClient && (!currentUser || currentUser.id !== 'offline_user')) {
                                lData.user_id = currentUser.id; 
                                await sbClient.from('transactions').update({ status: 'lunas_pinjaman' }).eq('id', tx.id); 
                                await sbClient.from('transactions').insert([lData]); 
                                await fetchUserTransactions(); 
                                showToast(`Pinjaman Lunas di Cloud`, "success");
                            } else {
                                db[idx].status = 'lunas_pinjaman'; 
                                lData.id = Date.now(); 
                                db.push(lData); 
                                pendingSync.push(lData); 
                                savePendingSync();
                                saveLocalDB(db); 
                                updateUI(document.getElementById('searchTxInput') ? document.getElementById('searchTxInput').value : ''); 
                                showToast(`Pinjaman Lunas (Menunggu Sync)`, "syncing");
                            }
                        } else { 
                            // Murni Guest Lokal
                            db[idx].status = 'lunas_pinjaman'; 
                            lData.id = Date.now(); 
                            db.push(lData); 
                            saveLocalDB(db); 
                            updateUI(document.getElementById('searchTxInput') ? document.getElementById('searchTxInput').value : ''); 
                            showToast(`Pinjaman Lunas (Lokal)`, "success"); 
                        } 
                    }); 
                } 
            }); 
        }
        
        async function checkAndAutoLunasHutang() { 
            let inT = 0, outT = 0; 
            db.filter(t => t.wallet === 'harian').forEach(t => { if(t.type === 'masuk') inT += t.amount; else outT += t.amount; }); 
            if((inT - outT) >= 0) { 
                let clear = false; 
                for (let t of db) { 
                    if(t.wallet === 'harian' && t.status === 'hutang') { 
                        if(currentUser && currentUser.id !== 'offline_user' && navigator.onLine && sbClient) await sbClient.from('transactions').update({ status: 'lunas_hutang' }).eq('id', t.id); 
                        else t.status = 'lunas_hutang'; 
                        clear = true; 
                    } 
                } 
                if(clear && (!currentUser || currentUser.id === 'offline_user' || !navigator.onLine)) saveLocalDB(db); 
                if(clear) showToast("Hutang otomatis lunas!", "success"); 
                if(clear && currentUser && currentUser.id !== 'offline_user' && navigator.onLine && sbClient) fetchUserTransactions();
            } 
        }

        document.getElementById('btnExecuteTx').addEventListener('click', async () => { 
            if(rawAmount <= 0) { showToast("Nominal 0", "error"); return; } 
            const isSaving = document.getElementById('tx-is-saving').value; 
            if (isSaving === 'true') return; 
            document.getElementById('tx-is-saving').value = 'true'; 
            
            const type = document.getElementById('tx-type').value; 
            let cF = document.getElementById('tx-category-manual').style.display === 'block' ? document.getElementById('tx-category-manual').value.trim() : document.getElementById('tx-category').value; 
            let dF = document.getElementById('tx-desc').value.trim(); 
            
            if(!cF || !dF) { showToast("Isi data dengan lengkap", "error"); document.getElementById('tx-is-saving').value = 'false'; return; } 
            const tabunganRegex = /tabung|tbgn|tbg|nabung/i;
            const isTabunganRelated = tabunganRegex.test(cF) || tabunganRegex.test(dF);
            
            cF = properTitleCase(cF); dF = properTitleCase(dF); 
            
            let stat = 'normal'; let brw = ''; let txToSave = []; 
            let sI_har = 0, sO_har = 0; db.filter(t => t.wallet === 'harian').forEach(t => { if(t.type === 'masuk') sI_har += t.amount; else sO_har += t.amount; }); let saldoHarian = sI_har - sO_har; 
            let sI_tab = 0, sO_tab = 0; db.filter(t => t.wallet === 'tabungan').forEach(t => { if(t.type === 'masuk') sI_tab += t.amount; else sO_tab += t.amount; }); let saldoTabungan = sI_tab - sO_tab; 

            if (activeWallet === 'harian' && isTabunganRelated) { 
                if (type === 'masuk') { 
                    showToast("Ditolak! Indikasi manipulasi tabungan.", "error"); 
                    document.getElementById('tx-is-saving').value = 'false'; return; 
                } else if (type === 'keluar') { 
                    if (saldoHarian < rawAmount) { showToast(`Saldo harian kurang!`, "error"); document.getElementById('tx-is-saving').value = 'false'; return; } 
                    txToSave.push({ wallet: 'harian', type: 'keluar', category: 'Pindah Tabungan', desc: 'Auto-Transfer Ke Tabungan', borrower: '', status: 'normal', amount: rawAmount, date: new Date().toISOString() }); 
                    txToSave.push({ wallet: 'tabungan', type: 'masuk', category: 'Setor Manual', desc: dF, borrower: '', status: 'normal', amount: rawAmount, date: new Date().toISOString() }); 
                } 
            } else if (activeWallet === 'tabungan' && /pindah|harian|tarik/i.test(cF) && cF.toLowerCase().includes('harian')) { 
                if (type === 'keluar') { 
                    if(rawAmount > saldoTabungan) { showToast("Saldo tabungan kurang!", "error"); document.getElementById('tx-is-saving').value = 'false'; return; } 
                    txToSave.push({ wallet: 'tabungan', type: 'keluar', category: 'Pindah Harian', desc: dF || 'Tarik Ke Dompet Harian', borrower: '', status: 'normal', amount: rawAmount, date: new Date().toISOString() }); 
                    txToSave.push({ wallet: 'harian', type: 'masuk', category: 'Dari Tabungan', desc: 'Suntikan Dana Tabungan', borrower: '', status: 'normal', amount: rawAmount, date: new Date().toISOString() }); 
                } 
            } else { 
                if(activeWallet === 'harian') { 
                    if(type === 'keluar') { if(saldoHarian - rawAmount < 0) { stat = 'hutang'; showToast("Dicatat Hutang", "error"); } } 
                    if (isLoanMode) { 
                        brw = properTitleCase(document.getElementById('tx-borrower').value.trim()); 
                        if(!brw) { showToast("Isi peminjam", "error"); document.getElementById('tx-is-saving').value = 'false'; return; } 
                        stat = 'dipinjam'; 
                    } 
                    txToSave.push({ wallet: activeWallet, type: type, category: cF, desc: dF, borrower: brw, status: stat, amount: rawAmount, date: new Date().toISOString() }); 
                } else if (activeWallet === 'tabungan') { 
                    if (type === 'keluar') { 
                        if(rawAmount > saldoTabungan) { showToast("Saldo tabungan kurang!", "error"); document.getElementById('tx-is-saving').value = 'false'; return; } 
                        if (isLoanMode) { 
                            brw = properTitleCase(document.getElementById('tx-borrower').value.trim()); 
                            if(!brw) { showToast("Isi peminjam", "error"); document.getElementById('tx-is-saving').value = 'false'; return; } 
                            stat = 'dipinjam'; 
                            txToSave.push({ wallet: activeWallet, type: type, category: cF, desc: dF, borrower: brw, status: stat, amount: rawAmount, date: new Date().toISOString() }); 
                        } 
                        else { 
                            const baseTime = Date.now(); 
                            txToSave.push({ wallet: 'tabungan', type: 'keluar', category: 'Pencairan', desc: `Dicairkan Untuk: ${dF}`, borrower: '', status: 'normal', amount: rawAmount, date: new Date(baseTime).toISOString() }); 
                            txToSave.push({ wallet: 'harian', type: 'masuk', category: 'Dari Tabungan', desc: `Pencairan Untuk: ${dF}`, borrower: '', status: 'normal', amount: rawAmount, date: new Date(baseTime + 1000).toISOString() }); 
                            txToSave.push({ wallet: 'harian', type: 'keluar', category: cF, desc: dF, borrower: '', status: 'normal', amount: rawAmount, date: new Date(baseTime + 2000).toISOString() }); 
                        } 
                    } else if (type === 'masuk') { 
                        if (saldoHarian < rawAmount) { showToast(`Saldo Harian kurang untuk ditabung!`, "error"); document.getElementById('tx-is-saving').value = 'false'; return; } 
                        txToSave.push({ wallet: 'harian', type: 'keluar', category: 'Pindah Tabungan', desc: 'Auto-Transfer Ke Tabungan', borrower: '', status: 'normal', amount: rawAmount, date: new Date().toISOString() }); 
                        txToSave.push({ wallet: 'tabungan', type: 'masuk', category: cF, desc: dF, borrower: '', status: 'normal', amount: rawAmount, date: new Date().toISOString() }); 
                    } 
                } 
            } 
            
            // LOGIKA PENYIMPANAN CERDAS (ONLINE/OFFLINE CLOUD/OFFLINE GUEST)
            if(wasLoggedIn || (currentUser && currentUser.id !== 'offline_user')) { 
                if (navigator.onLine && sbClient && (!currentUser || currentUser.id !== 'offline_user')) {
                    try { 
                        const payload = txToSave.map(t => { let data = { ...t, user_id: currentUser.id }; delete data.id; return data; });
                        const { error } = await sbClient.from('transactions').insert(payload); 
                        if(error) throw error;
                        
                        await fetchUserTransactions(); 
                        if(txToSave.some(t => t.wallet === 'harian' && t.type === 'masuk')) checkAndAutoLunasHutang(); 
                        closeModal('txModal'); showToast("Tersimpan di Cloud"); 
                    } catch(e) { 
                        showToast("Koneksi gagal. Menunggu Sync Offline.", "syncing"); 
                        txToSave.forEach(t => { t.id = Date.now() + Math.random(); db.push(t); pendingSync.push(t); }); 
                        savePendingSync(); saveLocalDB(db); closeModal('txModal'); updateUI(document.getElementById('searchTxInput') ? document.getElementById('searchTxInput').value : '');
                    }
                } else {
                    // Masukkan ke Antrean Sinkronisasi Offline (karena user sebenarnya punya akun)
                    txToSave.forEach(t => { t.id = Date.now() + Math.random(); db.push(t); pendingSync.push(t); }); 
                    savePendingSync(); saveLocalDB(db); 
                    if(txToSave.some(t => t.wallet === 'harian' && t.type === 'masuk')) checkAndAutoLunasHutang(); 
                    closeModal('txModal'); 
                    updateUI(document.getElementById('searchTxInput') ? document.getElementById('searchTxInput').value : ''); 
                    showToast("Tersimpan Offline (Menunggu Sync)", "syncing"); 
                    
                    const netStatus = document.getElementById('networkStatus');
                    if(netStatus) { netStatus.innerText = "Offline (Menunggu Sync)"; netStatus.className = "status-sync sync-pending"; }
                }
            } else { 
                // Mode Guest Murni
                txToSave.forEach(t => { t.id = Date.now() + Math.floor(Math.random() * 1000); db.push(t); }); 
                saveLocalDB(db); 
                closeModal('txModal'); 
                if(txToSave.some(t => t.wallet === 'harian' && t.type === 'masuk')) checkAndAutoLunasHutang(); 
                updateUI(document.getElementById('searchTxInput') ? document.getElementById('searchTxInput').value : ''); 
                showToast(txToSave.length > 1 ? "Tracker Transparan (Lokal)" : "Disimpan di Lokal"); 
            } 
            document.getElementById('tx-is-saving').value = 'false'; 
        });

        // ==========================================
        // 10. RENDER UI, AI ENGINE & GRAFIK (ANTI CRASH)
        // ==========================================
        function updateHealthEngine(filteredDb) { 
            let tIn = 0, tOut = 0; filteredDb.forEach(t => { if(t.type === 'masuk') tIn += t.amount; else tOut += t.amount; }); 
            let balance = tIn - tOut; const badge = document.getElementById('healthBadge'); const text = document.getElementById('healthText'); badge.className = 'health-badge'; 
            if (tIn === 0 && tOut === 0) { badge.classList.add('health-netral'); text.innerText = 'Netral'; } else if (balance < 0) { badge.classList.add('health-defisit'); text.innerText = 'Defisit'; } else if (balance >= 0 && balance <= 50000) { badge.classList.add('health-kritis'); text.innerText = 'Kritis'; } else { if (tOut > (tIn * 0.8)) { badge.classList.add('health-waspada'); text.innerText = 'Waspada'; } else { badge.classList.add('health-sehat'); text.innerText = 'Sehat'; } } 
            generateAIForecast(filteredDb); 
        }

        function generateAIForecast(data) { 
            const box = document.getElementById('aiInsightBox'); const textEl = document.getElementById('aiInsightText'); aiMessages = []; 
            if (data.length === 0) { 
                aiMessages.push("Belum ada data transaksi. Ayo mulai catat aktivitas keuanganmu!");
                if(!wasLoggedIn && (!currentUser || currentUser.id === 'offline_user')) aiMessages.push("Info: Hubungkan dengan Google agar datamu tersimpan aman di Cloud.");
                startAICarousel(textEl); return; 
            } 
            
            const today = new Date(); const currentMonthData = data.filter(t => { const d = new Date(t.date); return d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear(); }); 
            const masukData = currentMonthData.filter(t => t.type === 'masuk'); const keluarData = currentMonthData.filter(t => t.type === 'keluar'); 
            let mIn = masukData.reduce((sum, t) => sum + t.amount, 0); let mOut = keluarData.reduce((sum, t) => sum + t.amount, 0); 
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate(); 
            
            function calculateProjection(txArray, totalAmount) { if (txArray.length === 0) return 0; if (txArray.length === 1) return totalAmount; const sorted = [...txArray].sort((a,b) => new Date(a.date) - new Date(b.date)); const firstDate = new Date(sorted[0].date).getDate(); const lastDate = new Date(sorted[sorted.length-1].date).getDate(); let spanDays = lastDate - firstDate; if (spanDays === 0) spanDays = 1; const rate = spanDays / (txArray.length - 1); const futureTxCount = Math.floor((daysInMonth - lastDate) / rate); return totalAmount + (futureTxCount * (totalAmount / txArray.length)); } 
            
            let biggestExpenseMsg = "Belum ada data pengeluaran bulan ini untuk dianalisis.";
            if (keluarData.length > 0) { let catTotals = {}; keluarData.forEach(t => { catTotals[t.category] = (catTotals[t.category] || 0) + t.amount; }); let biggestCat = Object.keys(catTotals).reduce((a, b) => catTotals[a] > catTotals[b] ? a : b); biggestExpenseMsg = `Pengeluaran terbesarmu bulan ini tersedot di ${properTitleCase(biggestCat)} (${formatRp(catTotals[biggestCat])}).`; }
            
            if(!wasLoggedIn && (!currentUser || currentUser.id === 'offline_user')) aiMessages.push("Info: Wajib login (Google) jika ingin fitur Auto-Sync aktif!");
            aiMessages.push("Info: Saldo harian wajib diisi, karena akan mutasi otomatis dari dompet ke tabungan."); 
            
            let statusMsg = "", projectionMsg = "";
            if (activeWallet === 'harian') { 
                if (mOut > mIn && mIn > 0) { statusMsg = "⚠️ Peringatan! Total pengeluaran harianmu telah melampaui uang masuk bulan ini."; projectionMsg = "Saran AI: Segera kurangi pengeluaran agar keuangan tidak defisit di akhir bulan!"; box.style.borderLeftColor = 'var(--merah)'; box.querySelector('svg').style.color = 'var(--merah)'; } 
                else if (mOut > 0) { let forecastOut = calculateProjection(keluarData, mOut); statusMsg = "Aktivitas kas berjalan normal sesuai rutinitas harianmu."; if (keluarData.length === 1) { projectionMsg = `AI mencatat baru 1 pengeluaran harian (${formatRp(mOut)}). Belum ada pola terbaca.`; } else { projectionMsg = `Membaca Pola: Proyeksi pengeluaran harianmu di akhir bulan berpotensi mencapai ${formatRp(Math.round(forecastOut))}.`; } box.style.borderLeftColor = 'var(--kuning)'; box.querySelector('svg').style.color = 'var(--kuning)'; } 
                else if (mIn > 0 && mOut === 0) { statusMsg = "Awal yang luar biasa! Aset harianmu bulan ini masih utuh 100%."; projectionMsg = "Pertahankan! Jangan biarkan pengeluaran impulsif merusak rekor ini."; box.style.borderLeftColor = 'var(--hijau)'; box.querySelector('svg').style.color = 'var(--hijau)'; } 
                else { statusMsg = "Belum ada pergerakan kas harian di bulan ini."; projectionMsg = "Tips: Catat pemasukan pertamamu untuk memulai analitik cerdas!"; box.style.borderLeftColor = 'var(--biru)'; box.querySelector('svg').style.color = 'var(--biru)';}
            } else { 
                if (mOut > mIn && mIn > 0) { statusMsg = "⚠️ Tabungan defisit! Penarikan danamu bulan ini menghabiskan semua yang disetor."; projectionMsg = "Saran AI: Segera kembalikan dana brankas tabungan yang terpakai!"; box.style.borderLeftColor = 'var(--merah)'; box.querySelector('svg').style.color = 'var(--merah)'; } 
                else if (mIn > 0) { let projectedSavings = Math.round(calculateProjection(masukData, mIn) - calculateProjection(keluarData, mOut)); statusMsg = "Status Brankas: Pertumbuhan tabunganmu sedang berjalan dengan baik."; if (masukData.length === 1 && keluarData.length === 0) { projectionMsg = `Kamu menyetor ${formatRp(mIn)}. Pertahankan secara rutin agar AI bisa memproyeksi.`; box.style.borderLeftColor = 'var(--hijau)'; box.querySelector('svg').style.color = 'var(--hijau)'; } else if (projectedSavings > 0) { projectionMsg = `Berdasarkan rutinitasmu, potensi saldo tabungan di akhir bulan bisa menembus ${formatRp(projectedSavings)}!`; box.style.borderLeftColor = 'var(--hijau)'; box.querySelector('svg').style.color = 'var(--hijau)'; } else { projectionMsg = "Waspada! Proyeksi AI membaca saldomu akan habis di akhir bulan karena tarikan yang besar."; box.style.borderLeftColor = 'var(--kuning)'; box.querySelector('svg').style.color = 'var(--kuning)'; } } 
                else if (mIn === 0 && mOut === 0) { statusMsg = "Brankas tabunganmu belum ada aktivitas bulan ini."; projectionMsg = "Tips: Yuk, mulai sisihkan uangmu hari ini untuk disetor ke tabungan!"; box.style.borderLeftColor = 'var(--biru)'; box.querySelector('svg').style.color = 'var(--biru)'; } 
            } 
            aiMessages.push(statusMsg); aiMessages.push(projectionMsg); aiMessages.push(biggestExpenseMsg);
            aiMessages = [...new Set(aiMessages)].filter(m => m !== "");
            startAICarousel(textEl); 
        }
        
        function startAICarousel(textEl) { 
            if (aiCarouselInterval) clearInterval(aiCarouselInterval); 
            aiCurrentMsgIdx = 0; textEl.innerText = aiMessages[0]; textEl.classList.remove('fade-out'); 
            if (aiMessages.length > 1) { 
                aiCarouselInterval = setInterval(() => { 
                    textEl.classList.add('fade-out'); 
                    setTimeout(() => { 
                        aiCurrentMsgIdx = (aiCurrentMsgIdx + 1) % aiMessages.length; 
                        textEl.innerText = aiMessages[aiCurrentMsgIdx]; textEl.classList.remove('fade-out'); 
                    }, 400); 
                }, 10000); 
            } 
        }

        function openReceipt(txId) { 
            const strTxId = String(txId); const tx = db.find(t => String(t.id) === strTxId || String(t.date) === strTxId); if(!tx) return; 
            const rDate = formatDetailDate(tx.date); const rId = "TRX-" + new Date(tx.date).getTime().toString().slice(-8); 
            const rType = tx.type === 'masuk' ? 'Pemasukan' : 'Pengeluaran'; const rColor = tx.type === 'masuk' ? 'var(--hijau)' : 'var(--merah)'; 
            document.getElementById('receiptContent').innerHTML = ` 
                <div class="receipt-head">
                    <h3 style="margin:0 0 5px 0; color:var(--putih);">BUKTI MUTASI</h3>
                    <span style="font-size:11px; color:var(--text-muted); letter-spacing: 1px;">ID: ${rId}</span>
                </div> 
                <div class="receipt-row"><span class="receipt-label">Waktu</span><span class="receipt-val">${rDate}</span></div> 
                <div class="receipt-row"><span class="receipt-label">Dompet</span><span class="receipt-val" style="text-transform:capitalize;">${tx.wallet}</span></div> 
                <div class="receipt-row"><span class="receipt-label">Kategori</span><span class="receipt-val">${tx.category}</span></div> 
                <div class="receipt-row"><span class="receipt-label">Sifat</span><span class="receipt-val" style="color:${rColor};">${rType}</span></div> 
                <div class="receipt-row"><span class="receipt-label">Keterangan</span><span class="receipt-val">${tx.desc}</span></div> 
                ${tx.borrower ? `<div class="receipt-row"><span class="receipt-label" style="color:var(--kuning);">Peminjam</span><span class="receipt-val" style="color:var(--kuning);">${tx.borrower}</span></div>` : ''} 
                <div class="receipt-row" style="margin-top:25px; border-top:2px dashed #334155; padding-top:20px; align-items: flex-end;"> 
                    <span class="receipt-label" style="font-size:14px; color:var(--putih);">TOTAL</span> 
                    <span class="receipt-val" style="font-size:24px; color:${rColor}; letter-spacing:-1px;">${formatRp(tx.amount)}</span> 
                </div> 
            `; 
            document.getElementById('receiptModal').classList.add('active'); 
        }
        
        const searchInput = document.getElementById('searchTxInput'); 
        const searchClear = document.getElementById('searchClearBtn'); 
        if(searchInput) {
            searchInput.addEventListener('input', function(e) { 
                let val = e.target.value.toLowerCase(); searchClear.style.display = val.length > 0 ? 'block' : 'none'; updateUI(val); 
            }); 
        }
        function clearSearch() { searchInput.value = ''; searchClear.style.display = 'none'; updateUI(''); }
        
        function updateUI(searchTerm = '') {
            let tI = 0, tO = 0; 
            db.filter(t => t.wallet === 'harian').forEach(t => { if(t.type === 'masuk') tI += t.amount; else tO += t.amount; });
            const ban = document.getElementById('debtBannerContainer');
            if(activeWallet === 'harian' && (tI - tO) < 0) {
                ban.innerHTML = `<div class="hutang-banner"><div><span style="font-size:11px; font-weight:900; color:var(--merah);">Status Defisit</span><br><span style="font-size:16px; font-weight:900;">Minus: ${formatRp(Math.abs(tI - tO))}</span></div><button class="btn-quick glow-biru" style="padding:10px 15px; font-size:12px;" onclick="quickInput('masuk','Top-Up','Tutup Hutang')"><span>Top-Up</span></button></div>`;
            } else { ban.innerHTML = ''; }

            const today = new Date(); today.setHours(0,0,0,0);
            const fd = db.filter(tx => { 
                if(tx.wallet !== activeWallet) return false; 
                if(currentTimeFilter !== 0) { const d = new Date(tx.date); d.setHours(0,0,0,0); if(Math.floor(Math.abs(today - d) / 86400000) > currentTimeFilter) return false; } 
                if(searchTerm) { return tx.desc.toLowerCase().includes(searchTerm) || tx.category.toLowerCase().includes(searchTerm) || (tx.borrower && tx.borrower.toLowerCase().includes(searchTerm)); } 
                return true; 
            });

            updateHealthEngine(fd);
            let m = 0, k = 0; fd.forEach(t => { if(t.type === 'masuk') m += t.amount; else k += t.amount; });
            
            const dispSaldo = document.getElementById('disp-saldo');
            if(dispSaldo) { dispSaldo.setAttribute('data-short', formatRpPendek(m - k)); dispSaldo.setAttribute('data-full', formatRp(m - k)); }

            const dispMasuk = document.getElementById('disp-masuk');
            if(dispMasuk) { dispMasuk.setAttribute('data-short', formatRpPendek(m)); dispMasuk.setAttribute('data-full', formatRp(m)); }

            const dispKeluar = document.getElementById('disp-keluar');
            if(dispKeluar) { dispKeluar.setAttribute('data-short', formatRpPendek(k)); dispKeluar.setAttribute('data-full', formatRp(k)); }
            
            renderTable(fd); renderCharts(fd);
        }

        function renderTable(data) {
            const t = document.getElementById('table-body'); t.innerHTML = '';
            if(data.length === 0) { 
                t.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 30px; color:var(--text-muted);">Tidak ada transaksi pada rentang waktu ini.</td></tr>`; return; 
            }
            
            [...data].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(tx => {
                const iM = tx.type === 'masuk'; let c = getDynamicColor(tx.category, tx.type);
                let dr = `<span style="font-weight:700;">${tx.desc}</span>`;
                if(tx.status === 'dipinjam') dr = `<span style="font-weight:700; color:#a855f7;">${tx.desc}</span><br><span style="font-size:11px; color:var(--text-muted);">Dipinjamkan ke: <b style="color:var(--kuning);">${tx.borrower}</b></span>`;
                else if (tx.status === 'lunas_pinjaman' && tx.borrower) dr = `<span style="font-weight:700; color:var(--hijau);">${tx.desc}</span><br><span style="font-size:11px; color:var(--text-muted);">Peminjam: <b style="color:var(--putih);">${tx.borrower}</b></span>`;
                
                let cr = `<div class="badge-cat" style="border: 1px solid ${c}; color:${c}; background:rgba(0,0,0,0.5);">${tx.category}</div>`;
                if(tx.status === 'hutang') cr = `<div class="badge-cat" style="border: 1px solid var(--merah); color:var(--merah); background:rgba(239,68,68,0.2);">HUTANG</div>`;
                else if (tx.status === 'lunas_hutang') cr = `<div class="badge-cat" style="border: 1px solid var(--hijau); color:var(--hijau); background:rgba(16,185,129,0.1);">LUNAS</div>`;
                else if (tx.status === 'dipinjam') cr = `<div style="display:flex; flex-direction:column; gap:5px;"><div class="badge-cat" style="border: 1px solid #a855f7; color:#a855f7; background:rgba(168,85,247,0.2);">DIPINJAM</div><button class="btn-lunasi" onclick="lunasiPinjaman(event, '${tx.id || tx.date}')">${svgs.check} TANDAI LUNAS</button></div>`;
                else if (tx.status === 'lunas_pinjaman') cr = `<div class="badge-cat" style="border: 1px solid var(--hijau); color:var(--hijau); background:rgba(16,185,129,0.1);">LUNAS</div>`;

                t.innerHTML += `<tr class="clickable-row" onclick="openReceipt('${tx.id || tx.date}')"><td style="color:var(--text-muted); font-size:11px;">${formatDetailDate(tx.date).split(' - ')[0]}<br>${formatDetailDate(tx.date).split(' - ')[1]}</td><td>${cr}</td><td>${dr}</td><td class="amt-cell" style="color:${iM?'var(--biru)':'var(--merah)'};">${iM?'+':'-'}${formatRp(tx.amount)}</td></tr>`;
            });
        }

        function renderCharts(data) {
            // Pengaman agar UI Chart gak nyari file js saat offline murni
            if (typeof Chart === 'undefined') { console.warn("Sistem Grafik Offline / Gagal dimuat. UI text tetap aman."); return; }
            if (!document.getElementById('pieChart')) return; 
            Chart.defaults.color = '#64748b'; Chart.defaults.font.family = 'Inter';
            
            if(data.length === 0) {
                if(pieChart) pieChart.destroy(); if(barChart) barChart.destroy(); if(lineChart) lineChart.destroy();
                return;
            }
            
            const cA = {}; 
            data.forEach(t => { const k = `${t.category}`; if(cA[k]) { cA[k].a += t.amount; } else { cA[k] = { a: t.amount, color: getDynamicColor(t.category, t.type) }; } }); 
            const pL = Object.keys(cA);
            
            if(pieChart) pieChart.destroy(); 
            pieChart = new Chart(document.getElementById('pieChart'), { type: 'doughnut', data: { labels: pL, datasets: [{ data: pL.map(l => cA[l].a), backgroundColor: pL.map(l => cA[l].color), borderWidth: 4, borderColor: '#050814' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(c) { return ' ' + formatRp(c.raw); } } } } } });

            const rT = [...data].sort((a,b) => new Date(a.date) - new Date(b.date)).slice(-15);
            if(barChart) barChart.destroy(); 
            barChart = new Chart(document.getElementById('barChart'), { type: 'bar', data: { labels: rT.map(t => t.desc.substring(0,8)), datasets: [{ data: rT.map(t => t.type === 'masuk' ? t.amount : -t.amount), backgroundColor: rT.map(t => getDynamicColor(t.category, t.type)), borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(c) { return ' ' + formatRp(Math.abs(c.raw)); } } } }, scales: { x: { display: false }, y: { grid: { color: '#1e293b' } } } } });

            let cI = 0, cO = 0, hI = [], hO = []; 
            [...data].sort((a,b)=> new Date(a.date)-new Date(b.date)).forEach(t => { if(t.type === 'masuk') cI += t.amount; else cO += t.amount; hI.push(cI); hO.push(cO); });
            if(lineChart) lineChart.destroy(); 
            lineChart = new Chart(document.getElementById('lineChart'), { type: 'line', data: { labels: hI.map((_,i)=> `T${i+1}`), datasets: [{ label: 'Pemasukan Total', data: hI, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, pointRadius: 3, tension: 0.3 }, { label: 'Pengeluaran Total', data: hO, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, pointRadius: 3, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(c) { return ' ' + formatRp(c.raw); } } } }, scales: { x: { display: false }, y: { grid: { color: '#1e293b' } } } } });
        }

        // ==========================================
        // 12. SISTEM LUPA PIN & OTP EMAIL (DIKEMBALIKAN UTUH)
        // ==========================================
        function startOTPResetProcess() {
            closeModal('pinAuthModal');
            closeModal('resetPinModal');
            closeModal('resetTxPinAuthModal');
            
            if(!profile.googleLinked || !profile.googleEmail) {
                showToast("Akun belum terhubung ke Google!", "error");
                return;
            }
            if(!navigator.onLine) {
                showToast("Reset PIN butuh koneksi internet!", "error");
                return;
            }
            
            document.getElementById('displayUserEmail').innerText = profile.googleEmail;
            document.getElementById('otpRequestModal').classList.add('active');
        }

        function sendOTPEmail() {
            if(!navigator.onLine) {
                showToast("Koneksi terputus!", "error");
                return;
            }
            
            const btn = document.getElementById('btnSendOTP');
            btn.innerText = "Mengirim...";
            btn.disabled = true;

            // Generate 6 digit OTP acak
            generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
            otpExpiryTime = Date.now() + (5 * 60 * 1000); // Kadaluarsa 5 menit

            const templateParams = {
                to_email: profile.googleEmail,
                to_name: profile.name,
                otp_code: generatedOTP
            };

            emailjs.send('service_4v89q7h', 'template_5q05e2d', templateParams)
                .then(function(response) {
                    showToast("Kode terkirim ke Email!", "success");
                    closeModal('otpRequestModal');
                    
                    document.getElementById('inputOTP').value = '';
                    document.getElementById('inputNewPinOTP').value = '';
                    document.getElementById('otpVerifyModal').classList.add('active');
                    
                    btn.innerText = "Kirim Kode Sekarang";
                    btn.disabled = false;
                }, function(error) {
                    showToast("Gagal mengirim email!", "error");
                    btn.innerText = "Kirim Kode Sekarang";
                    btn.disabled = false;
                });
        }

        async function verifyOTPAndSavePin() {
            const inputCode = document.getElementById('inputOTP').value;
            const newPin = document.getElementById('inputNewPinOTP').value;

            if(Date.now() > otpExpiryTime) {
                showToast("Kode OTP Kadaluarsa!", "error");
                return;
            }

            if(inputCode !== generatedOTP) {
                showToast("Kode OTP Salah!", "error");
                return;
            }

            if(newPin.length < 4) {
                showToast("PIN Baru minimal 4 digit!", "error");
                return;
            }

            // Enkripsi dan simpan PIN baru
            profile.pin = await hashPIN(newPin);
            
            // Opsional: Hapus PIN Transaksi juga biar fresh
            profile.txPin = ''; 
            
            saveProfileLocal();
            await saveProfileToSupabase();
            
            generatedOTP = ""; // Reset kode di memori
            closeModal('otpVerifyModal');
            showToast("PIN Utama berhasil direset!", "success");
        }

        // ==========================================
        // 11. NYALAKAN MESIN UTAMA (TRIGER APLIKASI)
        // ==========================================
        window.addEventListener('load', bootApp);

    </script>
</body>
</html>
